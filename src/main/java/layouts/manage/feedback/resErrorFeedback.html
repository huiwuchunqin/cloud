 <!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<#include "/manage/common/meta_js.html"/> 
<#include "/manage/common/meta_css.html"/>
<title>资源纠错页面</title>
<style type="text/css">
.labelLine320 {
	float: left;
	width: 320px;
	line-height: 30px;
}
</style>
</head>
<body class="easyui-layout" data-options="fit:true">
	<div data-options="region:'north'">
		<div class="box">
			<div class="labelBox">
				<div class="labelLine440">
					<span class="labelWidth90">日期：</span>
					<input id="startDate" class="Wdate" onfocus="WdatePicker({maxDate:'#F{$dp.$D(\'endDate\')}',dateFmt:'yyyy-MM-dd'})"/>
					~ <input id="endDate" class="Wdate" onfocus="WdatePicker({minDate:'#F{$dp.$D(\'startDate\')}',dateFmt:'yyyy-MM-dd'})"/>
				</div>
				<div class="clear10"></div>
				<span class="labelLine250"> <span
					class="labelWidth90">资源类型：</span> <input class="easyui-combobox"
					id="resTypeL1"
					data-options="
						valueField: 'code',
						textField: 'name',
						panelHeight: 'auto',
						editable: false,
						data:[
							{name:'全部',code:'',selected:true},
							{name:'视频',code:'10'},
							{name:'音频',code:'12'},
							{name:'特色资源',code:'11'},
							{name:'互动资源',code:'15'},
							{name:'文档',code:'20'},	
						    {name:'测验',code:'30'},
						    {name:'题库',code:'50'}
						]" />
				</span>
				<div class="labelLine240">
					<span class="labelWidth90">处理状态：</span> <input
						class="easyui-combobox width120" id="disposeStatus"
						data-options="
								valueField: 'code',
								textField: 'name',
								panelHeight: 'auto',
								editable: false,
								data:[
									{name:'全部',code:''},
									{name:'待处理',code:'0',selected:true},
									{name:'已处理',code:'1'},
									{name:'无需处理',code:'2'}]
							" />
				</div>
			</div>
			<div class="btnBox">
				<button class="btn btnBlue search" onclick="query()">查询</button>
			</div>
		</div>
	</div>
	<div data-options="region:'center'">
		<div id="bar" class="btnToolbar">
			<button class="btn btnDelete" onclick="deleteRes()">删除</button>
			<button class="btn btnBlue" onclick="handle()">处理</button>
			<button class="btn btnBlue" onclick="noHandle()">无需处理</button>

		</div>
		<table id="dg" class="easyui-datagrid"
			data-options="
				 pagination:true, 
				 onBeforeLoad:onBeforeLoad,	
				 rownumbers:true,
			     toolbar:'#bar',
				 fit:true,
				 url:'/manage/feedback/search.html'
		    ">
			<thead>
				<tr>
					<th data-options="field:'ck',checkbox:true,width:80,halign:'center',headalign:'center'"></th>
					<th data-options="field:'id',hidden:true">id</th>
					<th data-options="field:'resCode',hidden:true">resCode</th>
					<th data-options="field:'resTypeL1',hidden:true">resTypeL1</th>
					<th data-options="field:'resName',formatter:resNameFmt,width:280,align:'left',halign:'center'">资源名称</th>
					<th data-options="field:'resTypeL1Name',width:100,align:'left',halign:'center'">资源类型</th>
					<th data-options="field:'disposeStatus',width:100,halign:'center',align:'center',formatter:disposeStatusfmt">处理状态</th>
					<th data-options="field:'userName',width:80,halign:'center',align:'left'">纠错人</th>
					<th data-options="field:'feedbackTime',width:160,align:'center',halign:'center'">报错时间</th>
					<th data-options="field:'errorDesc',formatter:operatefmt,width:120,align:'center',halign:'center'">纠错描述</th>
				</tr>
			</thead>
		</table>
	</div>

	<script type="text/javascript">
		//ajax请求
		function Ajax_request(url, data) {
			var result = [];
			$.ajax({
				url : url,
				data : data,
				async : false,
				type : 'post',
				success : function(json) {
					result = json;
				}
			});
			return result;
		}
		
		//处理状态转换
		function disposeStatusfmt(value, row) {
			var result = "";
			if (value == "0") {
				result = "<span style='color:red'>待处理</span>";
			} else if (value == "1") {
				result = "<span style='color:Lime'>已处理</span>";
			} else if (value == "2") {
				result = "<span style='color:gray'>无需处理</span>";
			}
			return result;
		}
		//类型格式化
		function resTypefmt(value, row) {
			var str = "";
			if (value == 10) {
				str = "视频";
			} else if (value == 20) {
				str = "文档";
			} else if (value == 11) {
				str = "特色资源";
			} else if (value == 12) {
				str = "音频";
			}  else if (value == 15) {
				str = "互动资源";
			} else if (value == 30) {
				str = "测验";
			} else {
				str = "题库";
			}
			return str;
		}

		//时间格式化
		function timefmt(value, row) {
			if (value != "" && value != undefined) {
				return moment(value).format("YYYY-MM-DD HH:mm");
			}
		}
		//查询按钮
		function query() {
			$('#dg').datagrid('reload');
		}

		//查询参数传递 
		function onBeforeLoad(param) {
			param["resTypeL1"] = $("#resTypeL1").combobox('getValue');
			param["resName"] = $("#resName").val();
			param["resCode"] = $("#resCode").val();
			var startDate = $("#startDate").val();
			var endDate = $("#endDate").val();
			if (endDate == "" || endDate == null) {
				endDate = moment(new Date()).format("YYYY-MM-DD");
			}
			param["startDate"] = startDate ? moment(startDate).format(
					"YYYYMMDD").toString() : "";
			param["endDate"] = endDate ? moment(endDate).format("YYYYMMDD")
					.toString() : "";
			param["disposeStatus"] = $("#disposeStatus").combobox('getValue');
		}
		//操作列格式化
		function operatefmt(value, row) {
			var str = "<a href='javascript:void(0)' onclick='detail(\""
					+ row.id + "\")'>查看详情</a>";
			return str;
		}
		//操作列格式化
		function docfmt(value, row) {
			var str = "<a href='javascript:void(0)'  onclick='detail(\""
					+ row.id + "\")'>" + value + "</a>";
			return str;
		}
		//查看详细
		function detail(id) {
			var param = {};
			param["id"] = id;
			easyui_openNoResizeWindow("纠错描述", 900, 600,
					"/manage/feedback/toResErrorFeedbackDaily.html",
					function(r) {
				        if(r){
							query();
				        }
					}, param);
		}
		//批量删除资源
		function deleteRes() {
			var rows = $('#dg').datagrid('getSelections');
			var ids = new Array();
			if (rows == undefined || rows.length <= 0) {
				$.messager.alert("信息", "请选择要删除的信息！", "info");
				return;
			}
			for (var i = 0; i < rows.length; i++) {
				ids.push(rows[i].id);
			}

			$.messager.confirm("信息", "是否删除该记录？", function(r) {
				if (r) {
					var result = Ajax_request(
							"/manage/feedback/deleteResErrorFeedback.html", {
								ids : ids.join(","),
								operateType : 1
							})
					$.messager.alert("信息", result.msg, "info", function() {
						if (result.success) {
							query();
						}
					})
				}
			})
		}

		//批量处理
		function handle() {
			var rows = $('#dg').datagrid('getSelections');
			var ids = new Array();
			if (rows == undefined || rows.length <= 0) {
				$.messager.alert("信息", "请选择要处理的信息！", "info");
				return;
			}
			for (var i = 0; i < rows.length; i++) {
				if (rows[i].disposeStatus != 0) {
					$.messager.alert("信息", "所选信息已被处理！", "info");
					return;
				}
				ids.push(rows[i].id);
			}
			//处理描述
			disposeDesc(ids, 1);
		}
		function disposeDesc(ids, operateType) {
			var param = {};
			param["ids"] = ids;
			param["operateType"] = operateType;
			easyui_openTopWindow("处理说明", 620, 350,
					"/manage/feedback/toResErrorFeedbackDisposeDesc.html",
					function(r) {
				        if(r){
							query();
				        }
					}, param);
		}
		//批量处理无需处理
		function noHandle() {
			var rows = $('#dg').datagrid('getSelections');
			var ids = new Array();
			if (rows == undefined || rows.length <= 0) {
				$.messager.alert("信息", "请选择要处理的信息！", "info");
				return;
			}
			for (var i = 0; i < rows.length; i++) {
				if (rows[i].disposeStatus != 0) {
					$.messager.alert("信息", "所选信息已被处理！", "info");
					return;
				}
				ids.push(rows[i].id);
			}
			//处理描述
			disposeDesc(ids, 2);
		}
		
		//资源名称列格式化
		function resNameFmt(value,row){
			if(row.resTypeL1==10||row.resTypeL1==20||row.resTypeL1==12||row.resTypeL1==15){
				return "<a href='javascript:void(0)' onclick='edit(\""+row.resCode+"\",\""+row.resTypeL1+"\",\""+row.id+"\",\""+row.disposeStatus+"\")'>"+value+"</a>";
			}else{
				return value; 
			}
		}
		
		//跳转到视频或文档查看编辑页面
		function edit(resCode,resTypeL1,id,disposeStatus){
			//首先需要去校验资源是否被删除
			var opts={
      				url:'/manage/feedback/checkResFlagDelete.html',
          			type:"post",
      				data:{
      					resCode:resCode,
      					resTypeL1:resTypeL1
      				},
      				success:function(res){
      					if(res.success){
      						easyui_openNoResizeWindow("资源编辑",940,700,"/manage/feedback/resEdit.html?check=0&resCode="+resCode+"&resTypeL1="+resTypeL1,function(r){},{},"mediaEdit");
      					}else{
      						$.messager.alert('系统提示',res.msg,'info',function(){
      							if(disposeStatus==0){
      								var disposeDesc="该资源已经被删除";
	      							var result = Ajax_request(
	      									"/manage/feedback/updateDescResErrorFeedback.html", {
	      										ids : id,
	      										disposeDesc : disposeDesc
	      									})
	      							Ajax_request("/manage/feedback/updateStatusResErrorFeedback.html",
	      									{
	      										ids : id,
	      										operateType : 1
	      									})
      							 query();
      							}
      						});
      					}
      				},
      				error:function(XMLHttpRequest, textStatus, errorThrown) {
      					alert("网络繁忙请稍后再试");
      				},
      				complete:function() {
      				   		
      				}
      	        }
			$.ajax(opts);
		}
	</script>
</body>
</html>