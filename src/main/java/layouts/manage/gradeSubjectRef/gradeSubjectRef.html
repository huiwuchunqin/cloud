<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<#include "/manage/common/meta_js.html"/> 
<#include "/manage/common/meta_css.html"/>
</head>
<style>
ul{ width:750px;margin-top:20px}
li{width:350px;float:left;border-bottom:1px solid #dddddd;border-left:1px solid #dddddd;padding:5px;line-height:20px;}
li span{width:80px;overflow:hidden;display:inline-block;margin-left:20px;height:23px;line-height:34px;font-family: "微软雅黑", Helvetica, Arial, sans-serif}
.memo{width:195px}
label{margin-left:5px;color:gray}
</style>
<body>
<div id="tb">
<div class="box">
	<div class="labelLine240">
		<label>选择学段：</label>
		<input class="easyui-combobox" id="section" data-options="onSelect:getSectionGrade,textField:'name',valueField:'code',editable:false">
	</div>
	<div class="labelLine350">
		<label>设定年级所对应的学科&nbsp;&nbsp;：</label>
		<input class="easyui-combobox"  id="grade" data-options="onSelect:onGradeSelect,textField:'name',valueField:'code',editable:false">
	</div>
	<div class="btnBox" >
		<a class="btn btnBlue" iconCls="icon-save" onclick="saveGradeSubjectRef()">保存</a>
	</div>
</div>
</div>
<table id="dg" class="easyui-datagrid"
	data-options="
	   toolbar:'#tb',
	   fit:true,
	   rownumbers:true,
	   fitColumns:true,
   ">
		<thead>
			<tr>
				<th data-options="field:'ck',checkbox:true,width:80,halign:'center',headalign:'center'"></th>
				<th data-options="field:'subjectName',halign:'center',width:100,align:'left'">学科名称</th>
				<th data-options="field:'description',width:450,halign:'center',align:'left'">描述</th>
			    <!-- <th data-options="field:'dispOrder',width:120,halign:'center',align:'right',headalign:'center'">显示顺序</th> -->
			</tr>
		</thead>
	</table>
<!-- <ul id="subjectList" data-bind="foreach:subjectList" >

	<li>
		<input type="checkbox" data-bind="value:subjectCode,checked:(selected==1)">
		<span data-bind="text:subjectName"> </span>
		<span class="memo" data-bind="visible:description"> <label data-bind="text:description"></label></span>
	</li>

</ul>
</div> -->
<script type="text/javascript">
var sectionList=eval(${sectionList});
$(function(){
	$('#section').combobox('loadData',sectionList);
	if(sectionList.length>0&&sectionList[0].code){
		$('#section').combobox('select',sectionList[0].code);	
	}
	/* bindData([]); */
})
//学段选择事件
function getSectionGrade(){
	$('#grade').combobox('clear');
	var sectionCode=$('#section').combobox('getValue');
	var sectionName=$('#section').combobox('getText');
	var opt={
			url:'/manage/sectionGradeRef/sectionGrade.html',
			data:{
				sectionCode:sectionCode
				},
			type:'post',
			success:function(json){
				if(json==null||json==""||json==undefined){
					$.messager.alert("信息","请先设置 <span style='color:red'>"+sectionName+"</span> 学段与年级的关系","info");
					$("#dg").datagrid('loadData',[]);
				}
				$('#grade').combobox('loadData',json);
				if(json.length>0&&json[0].code){
					$('#grade').combobox('select',json[0].code);	
				}
			}
	}
	$.ajax(opt);
}
//年级选择事件
function onGradeSelect(){
	var gradeCode=$('#grade').combobox('getValue');
	var sectionCode=$('#section').combobox('getValue');
	var sectionName=$('#section').combobox('getText');
	var opt={
			url:'/manage/gradeSubjectRef/gradeSubjectRefSet.html',
			data:{
				gradeCode:gradeCode,
				sectionCode:sectionCode,
				},
			type:'post',
			success:function(json){
				if(json==""||json==undefined||json==null){
					$.messager.alert("信息","请先设置<span style='color:red'>"+sectionName+"</span> 学段学科关系","info");
					 $("#dg").datagrid("loadData",[]);
				}
				$('#dg').datagrid('loadData',json);
				var result=eval(json);
				$.each(result,function(i,data){
					if(data.selected==1){
						 $("#dg").datagrid("checkRow", i);	
					}
				})
			/* 	var result=eval(json);
				modelView.subjectList(result);
				if(result.length>0){
					$('#tb').show();
				}else{
					$('#tb').hide();	
				} */
			}
	}
	$.ajax(opt);
}
//绑定数据
function bindData(list){
	ko.cleanNode($('#subjectList')[0]);
	modelView={subjectList:ko.observableArray(list)};
	ko.applyBindings(modelView,$('#subjectList')[0])
}
//保存年级学科关系
function saveGradeSubjectRef(){							
	var gradeCode=$('#grade').combobox('getValue');
	var subjectCodeArray=new Array();
	/* $("input[type='checkbox']:checked").each(function(){
		subjectCodeArray.push(this.value)
	}) */
	if(gradeCode==""||gradeCode==undefined){
		$.messager.alert("信息","请选择年级","info")
	}
	var rows=$('#dg').datagrid('getChecked');
	$.each(rows,function(){
		subjectCodeArray.push(this.subjectCode);
	})
	var opt={
		url:'/manage/gradeSubjectRef/gradeSubjectRefSave.html',
		data:{
			gradeCode:gradeCode,
			subjectCodeArray:subjectCodeArray,
		},
		type:'post',
		success:function(json){
		$.messager.alert("信息",json.msg,"info");
		}
	}
	$.ajax(opt);
}
</script>
</body>
</html>