<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>教材版本</title> <#include "/manage/common/meta_js.html"/> <#include
"/manage/common/meta_css.html"/>
</head>
<style type="text/css">
.tree-file {
    background:none;
}
</style>
<body class="easyui-layout">
<div data-options="region:'center'">
<div  id="tb">
	<div class="box">
		<div class="labelBox">
			<div class="labelLine240">
				<span class="labelWidth60">学段：</span>
				<input id="section" class="easyui-combobox"   data-options="onChange:onChange,textField:'name',valueField:'code',editable:false">
			</div>
			<div class="labelLine240">
				<span  class="labelWidth60">学科：</span>
				<input id="subject" class="easyui-combobox"   data-options="textField:'name',valueField:'code',editable:false">
			</div>
			<div class="labelLine240">
				<span class="labelWidth60">教材版本：</span>
				<input id="name" class="width130"  placeholder="请输入教材版本">
			</div>
		</div>
		<div class="btnBox">
			<a class="btn btnBlue search"  onclick="reload()">查询</a>
			<a class="btn btnBlue add" onclick="add()">新增</a>
		</div>
	</div>
</div>
<!--<div id="tb" style="height:30px">
	<a class="btn btnGrey" onclick="deleteVer()">删除</a> ;
</div>-->
	<table id="dg" class="easyui-treegrid" data-options="
	url:'/manage/textbook/textbookVerTree.html',
	toolbar:'#tb',
	idField:'id',
	treeField:'textbookverName',
    rownumbers:true,
    fitColumns:true,
    onBeforeLoad:onBeforeLoad,
    loadFilter:filter,
    singleSelect:true
	">
		<thead>
			<tr>
				<th data-options="field:'opt',width:55,formatter:optfmt,halign:'center',align:'center'">操作</th>
				<th data-options="field:'textbookverName',width:150,halign:'center',align:'left'">教材版本</th> 
				<th data-options="field:'sectionName',width:120,halign:'center',align:'center'">学段</th>
				<th data-options="field:'subjectName',width:120,halign:'center',align:'left'">学科</th>
				<th data-options="field:'modifyTime',formatter:timefmt,width:150,halign:'center',align:'center'">更新时间</th>
			</tr>
		</thead>
	</table>
</div>	
<script type="text/javascript">
 var sectionList=eval(${sectionList});
 var defaultOpt={name:"不限",code:'-1'};
 $(function(){
	 sectionList.splice(0,0,defaultOpt);
 	$('#section').combobox('loadData',sectionList);
	 $('#section').combobox('select',-1);
 })
 //学段选择事件
function onChange(record){
		sectionSubject(record,$('#subject'))
}
 //查询
 function reload(){
	 $('#dg').treegrid('reload') 
 }
 //新增
 function add(){
	 easyui_openNoResizeWindow("教材版本新增",780,400,"/manage/textbook/textbookVerAdd.html",function(r){
			 reload(); 
	 }) 
 }
 //修改
 function edit(textbookverName){
	 easyui_openNoResizeWindow("教材版本修改",780,400,"/manage/textbook/editTextbookVer.html?name="+encodeURI(encodeURI(textbookverName)),function(r){
			 reload();	 
	 })
 }
 //
 function onBeforeLoad(row,param){
	 param["sectionCode"]=$('#section').combobox('getValue');
	 param["subjectCode"]=$('#subject').combobox('getValue');
	 param["name"]=$('#name').val();
 }
 
 //数据过滤
 function filter(data){
	 if(data&&data.length>0){
		 _.each(data,function(item){
			 if(!item._parentId){
				 item.state="closed"; 
			 }
		 })
		 return {
			 total:data.length,
			 rows:data,
		 } 
	 }else{
		 return [];
	 }
	
 }
 //操作格式化 
 function optfmt(value,row){
	/*  if(!row._parentId){
		 return "<a href='javascript:void(0)' onclick='deleteVer(\""+row.textbookverName+"\")'>删除</a>&nbsp;&nbsp;<a href='javascript:void(0)' onclick='edit(\""+row.textbookverName+"\")'>修改</a>"
	 }else{
		 return "<a href='javascript:void(0)' onclick='deleteSubjectVer(\""+row.gid+"\")'>删除</a>"
		} */
	 if(!row._parentId){
		 return "<a href='javascript:void(0)' onclick='edit(\""+row.textbookverName+"\")'>修改</a>"
	 }
 }
 

 function deleteVer(name){
	 $.messager.confirm("信息","确定删除吗,一但删除将会影响保存的教材章节？",function(r){
		 if(r){
				$.ajax({
					url:'/manage/textbook/delTextbook.html',
					data:{
						name:name,
					},
					success:function(res){
						alert(res.msg);
						reload();
					}
				}) 
		 }
	 })
 }
 function deleteSubjectVer(gid){
	 $.messager.confirm("信息","确定删除吗,一但删除将会影响保存的教材章节？",function(r){
		 if(r){
				$.ajax({
					url:'/manage/textbook/delTextbookByGid.html',
					data:{
						gid:gid,
					},
					success:function(res){
						alert(res.msg);
						reload();
					}
				}) 
		 }
	 })
 }
 
 /* function  onCheck(rowData){
	 if(!rowData._parentId){
		 var children=$('#dg').treegrid('getChildren',rowData.id);
		 _.each(children,function(item){
			 $('#dg').treegrid('checkRow',item.id)
		 })
	 }else{
		 var children=$('#dg').treegrid('getChildren',rowData._parentId);
		 _.each(children,function(item){
		 })
		 
	 }
 }
 function onUnCheck(rowData,a,b){
	 var event=event||window.event;
	 event.stoppropagation;
	 if(!rowData._parentId){
		 var children=$('#dg').treegrid('getChildren',rowData.id);
		 _.each(children,function(item){
			 $('#dg').treegrid('uncheckRow',item.id)
		 })
	 } else{
		 $('#dg').treegrid('uncheckRow',rowData._parentId) 
	 }
 } */
 </script>
</body>
</html>