<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>课程统计-学生使用情况统计</title> 
<#include "/manage/common/meta_js.html"/>
<#include "/manage/common/meta_css.html"/>
<style type="text/css">
</style>
</head>
<body>
	<div class="easyui-layout" data-options="fit:true">
		<div data-options="region:'north'">
			<div class="box">
				<div class="labelBox">
					<div class="labelLine240">
						<span class="labelWidth60">学年学期：</span><input id="yearTerm"
							class="easyui-combobox" data-options="
							valueField: 'yearTermCode',
							textField: 'yearTermName', 
							panelHeight: 'auto',
							editable: false,
							data: [
								{yearTermCode: '',yearTermName: '全部'}
								<#if (yearTermList?exists && yearTermList?size>0)>
							  		<#list yearTermList as yearTerm>
							  			,{yearTermCode:'${yearTerm.yearTermCode}', yearTermName:'${yearTerm.yearTermName?default('&nbsp;')}'}
							  		</#list>
								</#if>
							]"/>
					</div>
					<div class="clear10"></div>
					<div class="labelLine240">
						<span class="labelWidth60">姓名：</span><input
							class="easyui-validatebox width130" id="userName" name="userName"
							maxlength="36" placeholder="请输入学生姓名" />
					</div>
					<div class="labelLine240">
						<span class="labelWidth60">学校：</span><input
							class="easyui-validatebox width130" id="orgName" name="orgName"
							maxlength="60" placeholder="请输入学校名称" />
					</div>
				</div>
				<div class="btnBox">
					<button class="btn btnBlue search" onclick="query()">查询</button>
				</div>
			</div>
		</div>
		<div data-options="region:'center'">
			<div id="tb" class="tbClass">
				<span class="attr" style="margin-left: 10px">人数：<label id="studentNum"></label></span> 
				<span class="attr" style="margin-left: 10px">课程总数：<label id="lessonNum"></label></span>
				<span class="attr" style="margin-left: 10px">已完成课程数：<label id="completedLessonNum"></label></span> 
				<span class="attr" style="margin-left: 10px">待完成课程数：<label id="noCompletedLessonNum"></label></span>
				<button class="btn btnBlue" style="float: right" onclick="exportData()">导出</button>
				<span style="clear: both; display: none"></span>
			</div>
			<table id="dg">
			</table>
		</div>
	</div>
	<script type="text/javascript">
    //查询
	function query() {
		$('#dg').datagrid('reload');
		queryTotal();
	}

	//查询总数
	function queryTotal() {
		var studyYearTermCode = $("#yearTerm").combobox('getValue');
		var orgName = $("#orgName").val();
		var userName = $("#userName").val();
		var opts = {
			url : '/manage/course/studentUse/searchTotal.html',
			type : "post",
			data : {
				studyYearTermCode : studyYearTermCode,
				orgName : orgName,
				userName : userName
			},
			success : function(data) {
				$('#studentNum').text(data.studentNum || 0);
				$('#lessonNum').text(data.lessonNum || 0);
				$('#completedLessonNum').text(data.completedLessonNum || 0);
				$('#noCompletedLessonNum').text(data.noCompletedLessonNum || 0);
			},
			error : function(XMLHttpRequest, textStatus, errorThrown) {
				alert("网络繁忙请稍后再试");
			},
			complete : function() {

			}
		}
		$.ajax(opts);
	}

	//页面初始化
	$(function() {
		<#if "${currentYearTermCode}" != "">
		   $('#yearTerm').combobox('setValue',"${currentYearTermCode}");
		</#if>
		//初始化dg
		$('#dg').datagrid({    
			 pagination:true,
			 onBeforeLoad:onBeforeLoad,
			 rownumbers:true,
			 singleSelect:true,
			 toolbar:'#tb',
			 fit:true,
			 url:'/manage/course/studentUse/search.html',
		     columns:[[    
		        {title:'姓名',field:'userName',align:'left',halign:'center',width:100},    
		        {title:'学校',field:'orgName',halign:'center',width:300,align:'left'},    
		        {title:'学习时长（小时）',field:'studyTotalTime',halign:'center',width:120,align:'center',formatter:studyTotalTimefmt},
		        {title:'已完成课程数',field:'completedCoureseNum',halign:'center',width:100,align:'center'},
		        {title:'待完成课程数',field:'uncompletedCoureseNum',halign:'center',width:100,align:'center'},
		        {title:'课程总数',field:'lessonNum',halign:'center',align:'center',width:100}
		    ]]   
		});  
		queryTotal();
	})
	
	function onBeforeLoad(param) {
		param["studyYearTermCode"] = $("#yearTerm").combobox('getValue');
		param["orgName"] = $("#orgName").val();
		param["userName"]=$("#userName").val();
	}

	//导出数据
	function exportData() {
		var studyYearTermCode = $("#yearTerm").combobox('getValue');
		var orgName = $("#orgName").val();
		var userName = $("#userName").val();
		var downloadUrl="/manage/course/studentUse/export.html?studyYearTermCode="+studyYearTermCode+"&userName="+encodeURI(userName)+"&orgName="+encodeURI(orgName)+"&fileName="+getExportName();
		downloadHelper(downloadUrl);
	}
	
    function studyTotalTimefmt(value, row){
		return  Math.round(value*100)/100;
    }
    </script>
</body>
</html>