<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<#include "/manage/common/meta_js.html"/> <#include
"/manage/common/meta_css.html"/>
<link rel="stylesheet" href="/manage/resources/css/auth/eduStaffAuthSet.css" />
<title>教研员-分配审核权限页面</title>
<script type="text/javascript">
	var mainViewModel = function() {
		self = this;
	}
	var page = new mainViewModel();
	var settingVo=eval(${settingVo});
	
</script>

</head>
<body>
	<div class="account-set-pop ">
		<div class="account-info">
			<div class="line-box">
				<div class="name text-color-light">登录账号：</div> 
				<div class="value">
					<span style="display: inline-block; height: 37px;line-height: 36px"
						data-bind="text:addAccount.loginAccount"></span>
				</div>
			</div>
		</div>
		<div class="option-box clearfix">
			<div class="name section-name text-color-light">审核学段:</div>

			<div class="value">
				<div class="clearfix section-list"
					data-bind="foreach:addAccount.sectionList">
					<div class="item section"
						data-bind="css:{'section-active':$root.addAccount.sectionActive()==$index()},click:function(){$root.addAccount.sectionActive($index())}">
						<span data-bind="text:name"></span>
					</div>
				</div>

				<div class="subject-box">
					<div class="text-color-light">审核学科:</div>

					<div data-bind="foreach:addAccount.sectionList">
						<div class="clearfix"
							data-bind="visible:$root.addAccount.sectionActive()==$index()">
							<div class="item"
								data-bind="click:$root.addAccount.changeSubjectSelectAll.bind($data)">
								<!--data-bind="click:$root.addAccount.isSubjectSelectAll.bind($data,!$root.addAccount.isSubjectSelectAll())"-->
								<span class="like-checkbox"
									data-bind="css:{'active':isSubjectSelectAll()}"> </span> <span>全部</span>
							</div>
							<!--<div data-bind="foreach:subjectList">-->
							<!-- ko foreach:subjectList-->
							<div class="item"
								data-bind="click:isSelect.bind($data,!isSelect())">
								<span class="like-checkbox"
									data-bind="css:{'active':isSelect()}"> </span> <span
									data-bind="text:name"></span>
							</div>
							<!-- /ko -->
							<!--</div>-->
						</div>
					</div>
				</div>
			</div>

		</div>
		<div class="option-box clearfix">
			<div class="name grade-name text-color-light">审核年级:</div>

			<div class="value">
				<div class="grade-box" data-bind="foreach:addAccount.sectionList">
					<div class="clearfix"
						data-bind="visible:$root.addAccount.sectionActive()==$index()">
						<div class="item"
							data-bind="click:$root.addAccount.changeGradeSelectAll.bind($data)">
							<span class="like-checkbox"
								data-bind="css:{'active':isGradeSelectAll()}"> </span> <span>全部</span>
						</div>
						<!-- ko foreach:gradeList-->
						<div class="item"
							data-bind="click:isSelect.bind($data,!isSelect())">
							<span class="like-checkbox" data-bind="css:{'active':isSelect()}">
							</span> <span data-bind="text:name"></span>
						</div>
						<!-- /ko -->
					</div>
				</div>
			</div>
		</div>

		<div class="btn-box">
			<button class="btn btnConfirm" data-bind="click:function(){page.addAccount.saveClick()}">保存</button>
			<button class="btn btnCancel"
				data-bind="click:page.addAccount.closeClick">取消</button>
		</div>
	</div>

	<script type="text/javascript">
		(function(page) {
			var self = page.addAccount = {
				loginAccount : ko.observable(''),
				userCode:ko.observable(''),
				sectionArray : [],//学段暂存数组
				sectionList : ko.observableArray([]),//学段ko数组,包括了学科、年级
				tag : 0,//标记学科，年级是否加载完毕，任意一个加载完毕置为1
				sectionActive : ko.observable(0),//当前学段tab激活项0、1、2...
				closeClick: function () {
					easyui_closeTopWindow(false);
	            }
			};
			/**
	         * 学科选择全部
	         * @param $data 当前学段下的Object
	         */
	        self.changeSubjectSelectAll = function ($data) {
	            $data.isSubjectSelectAll(!$data.isSubjectSelectAll());
	            if ($data.isSubjectSelectAll()) {
	                _.each(page.addAccount.sectionList()[page.addAccount.sectionActive()].subjectList(), function (subject) {
	                    subject.isSelect(true);
	                });
	            } else {
	                _.each(page.addAccount.sectionList()[page.addAccount.sectionActive()].subjectList(), function (subject) {
	                    subject.isSelect(false);
	                });
	            }
	        };
	        /**
	         * 年级选择全部
	         * @param $data 当前学段下的Object
	         */
	        self.changeGradeSelectAll = function ($data) {
	            $data.isGradeSelectAll(!$data.isGradeSelectAll());
	            if ($data.isGradeSelectAll()) {
	                _.each(page.addAccount.sectionList()[page.addAccount.sectionActive()].gradeList(), function (grade, j) {
	                    grade.isSelect(true);
	                });
	            } else {
	                _.each(page.addAccount.sectionList()[page.addAccount.sectionActive()].gradeList(), function (grade, j) {
	                    grade.isSelect(false);
	                });
	            }
	         };
	        
	         
			/**
		     * 请求学段、学科、年级
		     * @param type 'section'、'subject'、'grade'
		     * @param dataList 接受数据的数组
		     */
		    page.queryCommonList = function (type, dataList) {
		        var url = '';
		        switch (type) {
		            case 'section':
		                url = '/manage/section/list.html';
		                break;
		            case 'subject':
		                url = '/manage/sectionSubjectRef/list.html';
		                break;
		            case 'grade':
		                url = '/manage/sectionGradeRef/list.html';
		                break;
		        }
		        $.ajax({
		            url: url,
		            type: "post",
		            success: function (result) {
		                if (result) {
		                    _.each(result, function (d) {
		                        d.isSelect = ko.observable(false);
		                        d.active = ko.observable(false);
		                    });
		                    if (type == 'section') {//第一次请求学段、回调同步请求学科、年级
		                        page.queryCommonList('subject', page.addAccount.subjectList);
		                        page.queryCommonList('grade', page.addAccount.gradeList);
		                        page.addAccount.sectionArray = result;
		                    } else if (type == 'subject') {
		                        _.each(page.addAccount.sectionArray, function (section, i) {
		                        	(function(section){
		                        		 var subjectList = [];
				                            section.isSubjectSelectAll = ko.observable(false);//当前学段下面的学科是否全选
				                            _.each(result, function (subject, j) {
				                                if (section.code == subject.sectionCode) {
				                                    subjectList.push(subject);
				                                    subject.isSelect.subscribe(function (data) {
					                                    if (data) {
					                                        var flag = 1;
					                                        _.each(section.subjectList(), function (subject, j) {
					                                            if (!subject.isSelect()) {
					                                                flag = 0;
					                                            }
					                                        });
					                                        if (flag == 1) {
					                                        	section.isSubjectSelectAll(true);
					                                        }
					                                    } else {
					                                    	section.isSubjectSelectAll(false);
					                                    }
					                                });
				                                }
				                            });
				                            section.subjectList = ko.observableArray(subjectList);
		                        	})(section)
		                        });
		                        if (page.addAccount.tag == 1) {
		                            page.addAccount.sectionList(page.addAccount.sectionArray);
		                            initData(settingVo);
		                        } else {
		                            page.addAccount.tag = 1;
		                        }
		                        
		                    } else{
		                        _.each(page.addAccount.sectionArray, function (section, i) {
		                        	(function(section){
		                        		var gradeList = [];
			                            section.isGradeSelectAll = ko.observable(false);
			                            _.each(result, function (grade, j) {
			                                if (section.code == grade.sectionCode) {
			                                    gradeList.push(grade);
			                                    grade.isSelect.subscribe(function (data) {
					                                if (data) {
					                                    var flag = 1;
					                                    _.each(section.gradeList(), function (grade, j) {
					                                        if (!grade.isSelect()) {
					                                            flag = 0;
					                                        }
					                                    });
					                                    if (flag == 1) {
					                                    	section.isGradeSelectAll(true);
					                                    }
					                                } else {
					                                	section.isGradeSelectAll(false);
					                                }
					                            });
			                                    
			                                }
			                            });
			                            section.gradeList = ko.observableArray(gradeList);
		                        	})(section)
		                        });
		                      
		                        if (page.addAccount.tag == 1) {
		                            page.addAccount.sectionList(page.addAccount.sectionArray);
		                            //初始化数据
		                            initData(settingVo);
		                        } else {
		                            page.addAccount.tag = 1;
		                        }
		                    }
		                }
		            },
		            error: function () {
		                
		            }
		        });
		    }
			
			//保存操作
		    page.addAccount.saveClick = function () {
		        var submitFlag = 0;//用户选择不完全标记
		        var sectionCodes = '';
		        var subjectCodes = '';
		        var gradeCodes = '';
		        for (var i = 0; i <= page.addAccount.sectionList().length - 1; i++) {
		            var section = page.addAccount.sectionList()[i];
		            var subjectFlag = 0;
		            var gradeFlag = 0;
		            var subjectCodeBySection = '';
		            var gradeCodeBySection = '';
		            _.each(section.subjectList(), function (subject, j) {
		                if (subject.isSelect()) {
		                    subjectFlag = 1;
		                    subjectCodeBySection += subject.code + ',';
		                }
		            });
		            _.each(section.gradeList(), function (grade, k) {
		                if (grade.isSelect()) {
		                    gradeCodeBySection += grade.code + ',';
		                    gradeFlag = 1;
		                }
		            });
		            if (subjectFlag == 1 && gradeFlag == 1) {//只有同时选择了学科和年级才能审核该学段
		                sectionCodes += section.code + ',';
		                subjectCodes += subjectCodeBySection;
		                gradeCodes += gradeCodeBySection;
		            } else if (subjectFlag == 1 || gradeFlag == 1) {//用户只选择了学科或年级，提示用户
		                alert('只有同时选择了' + section.name + '下面的学科和年级才能审核该学段哦！')
		                submitFlag = 1;
		                return;
		            }
		        }

		        //去除尾端的逗号
		        sectionCodes = sectionCodes.substr(0, sectionCodes.length - 1);
		        subjectCodes = subjectCodes.substr(0, subjectCodes.length - 1);
		        gradeCodes = gradeCodes.substr(0, gradeCodes.length - 1);

		        if (sectionCodes == "") {
		            alert('至少选择一个审核的年级和学科！');
		            return;
		        }

		        var submitData = {
		        	loginAccount: page.addAccount.loginAccount(),
		            userCode: page.addAccount.userCode(),
		            priviledgeSectionCodes: sectionCodes,
		            priviledgeSubjectCodes: subjectCodes,
		            priviledgeGradeCodes: gradeCodes
		        };

		        var url = "/manage/eduStaff/authSet/save.html";
		        $.ajax({
		            url: url,
		            type: "post",
		            data: submitData,
		            success: function (result) {
		            	window.top.$.messager.alert("提示", result.msg, "info",function(){
		            		if (result.success) {
								easyui_closeTopWindow(true);
							}
		            	});
		            },
		            error: function () {
		                alert("网络异常~");
		            }
		        }); 
		    }
		    page.queryCommonList('section', page.addAccount.sectionList);
		})(page)
		
	</script>

	<script type="text/javascript">
		(function() {	
			ko.applyBindings(page);
		})()
		
		//数据初始化
		function initData(data){
	        	 page.addAccount.loginAccount(data.loginAccount);
	        	 page.addAccount.userCode(data.userCode);
				 if (data.priviledgeSectionVoList && data.priviledgeSectionVoList.length > 0) {
			            var sectionCode = data.priviledgeSectionVoList[0].sectionCode;//选中的用户第一个学段
			            for (var i = 0; i < page.addAccount.sectionList().length; i++) {
			                if (page.addAccount.sectionList()[i].code == sectionCode) {
			                    page.addAccount.sectionActive(i);
			                    break;
			                }
			            }
			        }
			        //选中年级
			        _.each(data.priviledgeGradeVoList, function (grade) {
			            _.each(page.addAccount.sectionList(), function (section) {
			                _.each(section.gradeList(), function (g) {
			                    if (g.code == grade.gradeCode) {
			                        g.isSelect(true);
			                    }
			                });
			            });
			        });
			        //选中学科
			        _.each(data.priviledgeSubjectVoList, function (subject) {
			            _.each(page.addAccount.sectionList(), function (section) {
			                _.each(section.subjectList(), function (s) {
			                    if (s.code == subject.subjectCode) {
			                        s.isSelect(true);
			                    }
			                });
			            });
			        });
	         }
	</script>

</body>
</html>