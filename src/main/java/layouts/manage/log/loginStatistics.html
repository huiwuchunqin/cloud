<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <#include "/manage/common/meta_js.html"/>
    <#include "/manage/common/meta_css.html"/>
    <title>登陆次数统计</title>
</head>
<body>
    <div class="easyui-layout" data-options="fit:true">
        <div data-options="region:'north'">
            <div class="box">
            <div class="labelBox">
                <div class="labelLine440">
                    <span class="labelWidth60">日期：</span>
                    <input id="startTime" class="Wdate" onfocus="WdatePicker({maxDate:'#F{$dp.$D(\'endTime\')}',dateFmt:'yyyy-MM-dd'})" />
                    <span>~</span>
                    <input id="endTime" class="Wdate" onfocus="WdatePicker({minDate:'#F{$dp.$D(\'startTime\')}',dateFmt:'yyyy-MM-dd'})" />
                </div>
                <span class="clear10"></span>
                <div class="labelLine240">
                    <span class="labelWidth60">角色：</span>
                    <input id="role">
                </div>
                <span class="clear10"></span>
                <div class="labelLine240">
                    <span class="labelWidth60">机构名称：</span>
                    <input id="orgName" placeholder="请输入机构名称">
                </div>
            </div>
            <div class="btnBox">
                    <button id="btn-search" class="btn btnBlue">查询</button>
            </div>
            </div>
        </div>

        <div data-options="region:'center'">
            <div id="tb" class="tbClass" style="height: 27px">
                <span class="attr">总计(次数)：<label id="totalNum"></label></span>
                <div class="btnBox">
                    <button id="btn-export" class="btn btnBlue right">导出</button>
                </div>
            </div>
            <table id="dg"></table>
        </div>

    </div>

    <script>
        $('#role').combobox({
            editable: false,
            textField: 'name',
            valueField: 'code',
            data: [{ name: '全部', code: '', selected: true },
            { name: '老师', code: '10' }, { name: '学生', code: '20' }]
        });

       
        $('#dg').datagrid({
            url: '/manage/loginStatistics/search.html',
            pagination: true,
            rownumbers: true,
            singleSelect: true,
            fit: true,
            toolbar: '#tb',
            onBeforeLoad: getParams,
            onLoadSuccess: onLoadSuccess,
            columns: [[
                { field: 'orgName', title: '学校', width: 300, formatter: orgFormatter },
                { field: 'PC', title: 'PC', width: 100, align: 'center' },
                { field: 'androidPad', title: '安卓平板', width: 100, align: 'center' },
                { field: 'ipad', title: 'iPad', width: 100, align: 'center' },
                { field: 'androidPhone', title: '安卓手机', width: 100, align: 'center' },
                { field: 'iphone', title: 'iPhone', width: 100, align: 'center' },
                { field: 'total', title: '总计(次数)', width: 100, align: 'center' }
            ]]
        });

        $('#btn-search').click(function () {
            $('#dg').datagrid('reload');
        });

        $('#btn-export').click(function () {
            var param = {};
            getParams(param);
            downloadHelper(urlWithParam('/manage/loginStatistics/export.html', param));
        });

        function onLoadSuccess(data) {
            if (data.pageNo > 1) return;
            
            var param = {};
            getParams(param);
            $.ajax({
                url: '/manage/loginStatistics/total.html',
                type: 'post',
                data: param
            }).then(function (res) {
                if (res.success)
                    $('#totalNum').text(res.data);
            });
        }

        function getParams(param) {
            var startTime = $('#startTime').val(),
                endTime = $('#endTime').val();

            param.orgName = $('#orgName').val().replace(/^\s+|\s+$/g,'');
            param.role = $('#role').combobox('getValue');
            param.startTime = startTime && startTime + ' 00:00:00.000';
            param.endTime = endTime && endTime + ' 23:59:59.999';
        }


        function orgFormatter(value, row) {
            return '<a href="javascript:void(0)" class="easyui-linkbutton" onclick="viewDetail(\'' + row.orgCode + '\',\''+row.orgName+'\')">' + value + '</a>'
        }


        function viewDetail(orgCode,orgName) {
            var param = {
                orgCode: orgCode,
            }
            getParams(param);
            param.orgName= orgName;
            var url = urlWithParam('/manage/loginStatisticsDetail/list.html', param);

            window.top.$("#tab").tabs('close', '学校登录次数统计详情');
            window.top.$("#tab").tabs('add', {
                title: '学校登录次数统计详情',
                closable: true,
                content: '<iframe scrolling="no" frameborder="0" src="' + url + '" style="width:100%;height:100%;"></iframe>'
            });
        }
    </script>
</body>