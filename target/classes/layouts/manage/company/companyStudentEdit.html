<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<#include "/manage/common/meta_js.html"/> <#include
"/manage/common/meta_css.html"/>
<script type="text/javascript"
	src="/manage/template/comboChange/comboChange.js"></script>
</head>
<body>
<form id="fm" class="fom box">
			<div class="attrDiv">
				<span>姓名</span> <input id="userName" class="easyui-validatebox width130" maxlength="30"
					data-options="required:true" disabled="disabled"> 
			</div>
			<div class="attrDiv">
				<span>学号</span> <input id="studentNumber" class="easyui-validatebox width130" maxlength="20"
							data-options="required:true,validType:'alphaChar[0,20]'">
			</div>
			<span class="clear10"></span>
			<div class="attrDiv">
				<span>年级</span> <input id="grade" class="easyui-combobox"
					data-options="onChange:gradeChange,textField:'name',valueField:'code',editable:false">
			</div>
			<div class="attrDiv">
				<span>学期</span> <input id="term" class="easyui-combobox"
					data-options="textField:'name',valueField:'code',editable:false,data:[{'name':'上学期',code:'1'},{'name':'下学期',code:'2'}]">
			</div>
			<span class="clear10"></span>
			<div class="attrDiv">
				<span>行政班级</span> <input id="adminClass" class="easyui-combobox"
					data-options="required:true,textField:'className',valueField:'classCode',editable:false">
			</div>
				
			<div class="attrDiv">
				<span>入学年月</span> <input  id="enterSchoolDate" class="wdate easyui-validatebox width130"
					onfocus="WdatePicker({dateFmt:'yyyy-MM-dd'})" >
			</div>
			<span class="clear10"></span>
			<div class="attrDiv">
				<span>性别</span> <input id="gender" class="easyui-combobox"
					data-options="
					textField:'name',
					valueField:'code',
					editable:false,
					data:[
					{'name':'女','code':'2'},
					{'name':'男','code':'1'}
					]">
			</div>
			<div class="attrDiv">
				<span>手机号</span> <input id="mobilePhone" class="easyui-validatebox width130"
					data-options="validType:'mobile'">
			</div>
			<span class="clear10"></span>
			<div class="attrDiv">
				<span>邮箱</span> <input id="mail" class="easyui-validatebox width130" data-options="validType:'email'">
			</div>
			<div class="attrDiv">
				<span>硬件号</span> <input id="studentHardNo" class="easyui-validatebox width130" data-options="validType:'alphanumMaxLength[20]'">
			</div>
			<input id="gid" hidden="hidden">
			<span class="clear" ></span>
			<div class="align-right">
			<a class="btn btnConfirm" onclick="saveStudent()" >保存</a>
			<a class="btn btnCancel" onclick="closeTop()" >取消</a>
			</div>
		</form>
<script type="text/javascript">
var student=eval(${student});
var gradeCode="${gradeCode}";
var gradeList=eval(${gradeList});
var gradeCombo=$('#grade');
var classCombo=$('#adminClass');
var termCombo=$('#term');
var loginUser=eval(${loginUser});
var firstLoad=true;
$(function(){
	gradeCombo.combobox('loadData',gradeList);
	gradeCombo.combobox('setValue',student.gradeCode);
	if(gradeCode!=""){
		gradeCombo.combobox('setValue',gradeCode);
		gradeCombo.combobox('disable');	
	}
	$('#studentNumber').val(student.studentNumber);
	$('#userName').val(student.userName);
	$('#gender').combobox('setValue',student.gender);
	if(student.enterSchoolDate){
		$('#enterSchoolDate').val(moment(student.enterSchoolDate).format("YYYY-MM-DD"));
	}else{
		$('#enterSchoolDate').val("");
	}
	$('#gid').val(student.gid);
	$('#mobilePhone').val(loginUser.mobilePhone),
	$('#mail').val(loginUser.mail)
	$('#studentHardNo').val(student.studentHardNo)
	termCombo.combobox('setValue',student.termCode);
})
//年级选择事件
function gradeChange(newValue){
	$.ajax({
		url:'/manage/adminClass/getAdminClassList.html',
		data:{
			gradeCode:newValue
		},
		success:function(res){
			classCombo.combobox('clear');
			classCombo.combobox('loadData',res);
			if("${adminClassCode}"){
				classCombo.combobox('setValue',"${adminClassCode}");
				classCombo.combobox('disable');	
			}
			if(student&&firstLoad){
				classCombo.combobox('setValue',student.adminClassCode);
				firstLoad=false;
			}
		}
	})
}
//关闭学生编辑窗口
function closeTop(){
	easyui_closeTopWindow(false)
}
//保存学生
function saveStudent(){
	/* if($('#enterSchoolDate').val()==""){
		$.messager.alert("信息","请输入入学年月","info");
		return false;
	} */
	//学号验证规则：纯数字/纯字母/数字字母的组合
	var rule = /^[0-9a-zA-Z]*$/g;
	var studentNumber=$('#studentNumber').val();
	if(!rule.test(studentNumber)){
		$.messager.alert("信息","学号格式不对，请输入纯数字或纯字母或数字字母组合格式的学号！","info");
		return false;
	}
	var newStudent={
			gradeCode:gradeCombo.combobox('getValue'),
		 	termCode:termCombo.combobox('getValue'),
		 	adminClassCode:encodeURI(classCombo.combobox('getValue')),
		    studentNumber:studentNumber,
			userName:$('#userName').val(),
			gender:$('#gender').combobox('getValue'), 
		 	enterSchoolDateStr:$('#enterSchoolDate').val(),
			mobilePhone:$('#mobilePhone').val(),
			mail:$('#mail').val(),
			studentHardNo:$('#studentHardNo').val(),
		};
	_.extend(student,newStudent);
	delete student.enterSchoolDate;
	delete student.modifyTime;
	if($('#fm').form('validate')){
		$.ajax({
			url:'/manage/student/saveOrUpdateStudent.html',
			data:student,
			type:'post',
			success:function(res){
				alert(res.msg);
				if(res.success){
					easyui_closeTopWindow(true);
				}
			}
		})
	}	
}

</script>		
</body>
</html>