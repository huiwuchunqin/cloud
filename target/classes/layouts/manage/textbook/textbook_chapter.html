<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>教材章节信息</title> 
<#include "/manage/common/meta_js.html"/>
<#include "/manage/common/meta_css.html"/>
<script type="text/javascript" src="/manage/template/comboChange/comboChange.js"></script>
<script type="text/javascript" src="/manage/template/helper/helper.js"></script>
</head>
<style type="text/css">
.shang{
    	background: url(/manage/template/images/moveUp.png) no-repeat center;
	    width: 20px;
	    position: relative;
	    top: 3px;
	    height: 15px;
	    display: inline-block;
	    margin-left:30px;
	    border-style:none;
    	border-width:0;

}
img:hover{
transfrom:scale{2,2};
}
.xia{
        background: url(/manage/template/images/moveDown.png) no-repeat center;
	    width: 20px;
	    position: relative;
	    top: 2px;
	    height: 15px;
	    display: inline-block;
	    border:1px solid #FFFFFF;
	    border-style:none;
	    border-width:0;
}
.datagrid-row-selected  #moveArea,.datagrid-row-over  #moveArea{
	display:inline-block!important
}
#moveArea{
display:none
}
</style>
<body>
	<div class="easyui-layout" data-options="fit:true">
		<div data-options="region:'north',split:false,border:false"> 
			<div class="box form">
				<div class="labelBox">
					<!-- 学段 -->
					<div class="labelLine240">
						<div class="labelWidth60">学段：</div>
						<input class="easyui-combobox" id="section"
							data-options="
							valueField: 'code',
							textField: 'name',
							panelHeight: 'auto',
							editable: false,
							data: [
								{code: '',name: '不限',selected:true}
								<#if (sectionList?exists && sectionList?size>0)>
							  		<#list sectionList as section>
							  			,{code:'${section.code}', name:'${section.name?default('&nbsp;')}'}
							  		</#list>
								</#if>
							],onSelect:sectionSelect" />
					</div>
					<!-- 学科 -->
					<div class="labelLine240">
						<div class="labelWidth60">学科：</div>
						<input class="easyui-combobox" id="subject"
							data-options="
							valueField: 'code',
							textField: 'name',
							panelHeight: 'auto',
							editable: false,
							data: [{code:' ',name: '不限',selected:true}],
							onSelect:subjectSelect
							" />
					</div>
					<!-- 年级 -->
					<div class="labelLine240">
						<div class="labelWidth60">年级：</div>
						<input class="easyui-combobox" id="grade"
							data-options="
							valueField: 'code',
							textField: 'name',
							panelHeight: 'auto',
							editable: false,
							data: [{code:'',name: '不限',selected:true}]
							" />
					</div>
					<!--<div class="clear10"></div>-->
					<!-- 教材版本 -->
					<div class="labelLine240">
						<div class="labelWidth90">教材版本：</div>
						<input class="easyui-combobox" id="version"
							data-options="
							valueField: 'code',
							textField: 'name',
							panelHeight: 'auto',
							editable: false,
							data: [{code:'',name: '请选择',selected:true}]
				
							" />
					</div>
			<!-- 		<div class="labelLine300">
							<div class="labelWidth90">教材</div>
							<input class="easyui-combobox" id="textbook"
								data-options="
											valueField: 'tbCode',
											textField: 'tbName',
											panelHeight: 'auto',
											editable: false,
											data: [{tbCode:'',tbName: '请选择教材版本',selected:true}]
											" />
						</div> -->
				</div>
				<div class="btnBox" >
					<button id="btnAdd"class="btn btnBlue" 
						 onclick="addTextbook()" >新增教材</button>
					<button id="btnSearch" class="btn btnBlue search l10" 
						 onclick="queryChapter()"
						>查询</button>
				</div>
			</div>
		</div>
		<!-- <div data-options="region:'center',border:false,title:'教材章节结构'">
			<ul class="easyui-tree" id="chapter_tree" data-options="
				animate: true"></ul>
		 </div>-->
		<div data-options="region:'center'">
			<table id="chapter_tree">
				
			</table>
			<div id="chapter_menu" class="easyui-menu" style="width: 120px;"
				data-options="onClick:chapterMenuHandler">
				<div id="addSibling"
					data-options="name:'addSibling',iconCls:'icon-add'">添加同级节点</div>
				<div id="addChild" data-options="name:'addChild',iconCls:'icon-add'">添加子节点</div>
				<div id="editChapter"
					data-options="name:'editChapter',iconCls:'icon-edit'">修改</div>
				<div id="deleteChapter"
					data-options="name:'deleteChapter',iconCls:'icon-remove'">删除</div>
			</div>
			<div id="textbook_menu" class="easyui-menu" style="width: 120px;"
				data-options="onClick:textbookMenuHandler">
				<div id="addTextbook"
					data-options="name:'addTextbook',iconCls:'icon-add'">添加教材</div>
				<div id="addChapter"
					data-options="name:'addChapter',iconCls:'icon-add'">添加教材章节</div>
				<div id="editTextbook"
					data-options="name:'editTextbook',iconCls:'icon-edit'">修改</div>
				<div id="deleteTextbook"
					data-options="name:'deleteTextbook',iconCls:'icon-remove'">删除</div>
			</div>
		</div>
	</div>
	<script type="text/javascript">
		var subjectCode = "";
		var textbookVerCode = "";
		var textbookCode = "";
		var sectionCode = "";
		var gradeCode = "";

		var defaultOpt = {
			name : "请选择",
			code : ''
		};
		//样式 
		function rowStyle(row){
			if(row!=""&&row!=undefined&&row.nodeType=="textbook"){
				return 'font-family: SimSun;font-weight: bold;font-size:30px;weight:20px';
			}
		}
		
		$(function(){
			<#if "${sectionCode}" != ""&&"${subjectCode}" != "">
			   $('#section').combobox('setValue',"${sectionCode}");
			   sectionSubject("${sectionCode}", $('#subject'));
			   sectionGrade("${sectionCode}", $('#grade'));
			   $('#version').combobox('clear');
			   $('#version').combobox('loadData',[{code:'',name: '请选择'}]);
			   $('#subject').combobox('setValue',"${subjectCode}"); 
			   subjectTextbookVer("${subjectCode}", $('#version'));	
			</#if>
			$('#chapter_tree').treegrid({    
			     url:'/manage/textbook/getChapterTree.html',    
			     idField:'gid',
				 treeField:'text',
				 fit:true,
				 striped:false,
				 onContextMenu:gridOnContextMenu,
				 onBeforeLoad:onBeforeLoad,
				 toolbar:'#bar',
				 onLoadSuccess:onLoadSuccess,
				 rowStyler:rowStyle,
			     columns:[[    
			        {title:'教材',field:'text',align:'left',formatter:sortfmt,halign:'center',width:400},    
			        {title:'学段',field:'sectionName',halign:'center',width:70,align:'center'},
			        {title:'学科',field:'subjectName',halign:'center',width:90,align:'left'},
			        {title:'年级',field:'gradeName',halign:'center',width:70,align:'left'}, 
			        {title:'教材版本',field:'textbookVerName',halign:'center',width:100,align:'left'},
			        {title:'描述',field:'description',halign:'center',align:'left',width:400}    
			    ]]   
			});  
		})
		
		//学段选择事件
		function sectionSelect(record) {
			sectionGrade(record.code, $('#grade'));
			sectionSubject(record.code, $('#subject'));
			$('#version').combobox('clear');
			$('#version').combobox('loadData',[{code:'',name: '请选择'}]);
		}
		//年级选择事件
		function gradeSelect(record) {
			gradeSubject(record.code, $('#subject'));
		}
		//学科选择事件
		function subjectSelect(record) {
			if(record.code==""){
				$('#version').combobox('clear');
				$('#version').combobox('loadData',[{name:'请选择',code:''}])
			}else{
				subjectTextbookVer(record.code, $('#version'));	
			}
		}
	/* 	//教材版本选择事件
		function textbookVerSelect(record){
			var sectionCode=$("#section").combobox('getValue');
			var subjectCode=$("#subject").combobox('getValue');
			var gradeCode=$("#grade").combobox('getValue');
			textbookVerTextbook(sectionCode,subjectCode,gradeCode,record.code,$('#textbook'))
		} */
		function onLoadSuccess() {

		}
		function onBeforeLoad(row, param) {
			//学段
			sectionCode = $('#section').combobox('getValue');
			//年级
			gradeCode = $('#grade').combobox('getValue');
			//学科
			subjectCode = $('#subject').combobox('getValue');
			//教材版本
			textbookVerCode = $('#version').combobox('getValue');
			//查询
			if (row != undefined && row != null) {
				param["nodeType"] = row.nodeType;
				param["code"] = row.code;
			}
			param["sectionCode"] = sectionCode;
			param["subjectCode"] = subjectCode;
			param["gradeCode"] = gradeCode;
			param["textbookVerCode"] = textbookVerCode;
		/* 	param["textbookCode"] = textbookCode; */
		}
		//查询教材章节
		function queryChapter() {
			$('#chapter_tree').treegrid('reload');
		}
		//当右键点击节点时触发菜单
		function gridOnContextMenu(e, node) {
			e.preventDefault();
			$(this).treegrid("select", node.gid);
			if (node.nodeType == "textbook") {
				//显示右键菜单
				$("#textbook_menu").menu("show", {
					left : e.pageX,
					top : e.pageY
				});
			} else if (node.nodeType == "chapter") {
				//显示右键菜单
				$("#chapter_menu").menu("show", {
					left : e.pageX,
					top : e.pageY
				});
			}

		}
		//章节右击菜单选项 
		function chapterMenuHandler(item) {
			var node = $('#chapter_tree').treegrid('getSelected');
			var level = node.level;
			var pcode = node.pcode;
			var name = item.name;
			if (name == "addSibling" || name == "addChild") {
				if (name == "addChild") {
					level = level + 1
					pcode = node.code;
				}
				addChapter(level, pcode, node.tbCode, name, node.gid);
			} else if (name == "editChapter") {
				editChapter(node);
			} else if (name = "deleteChapter") {
				delChapter(node.gid);
			}

		}
		//教材右击菜单选项 
		function textbookMenuHandler(item) {
			var node = $('#chapter_tree').treegrid('getSelected');
			var name = item.name;
			if (name == "addTextbook") {
				addTextbook("", node.gid);
			} else if (name == "addChapter") {
				addChapter(1, "", node.code, "addChild", node.gid)
			} else if (name == "editTextbook") {
				editTextbook(node);
			} else if (name = "deleteTextbook") {
				delTextbook(node.gid);
			}
		}
		//删除章节
		function delChapter(gid) {
			$.messager.confirm("信息", "确认要删除吗?", function(r) {
				if (r) {
					$.ajax({
						url : "/manage/textbook/chapter/delete.html",
						data : {
							gid : gid,
						},
						dataType : "json",
						success : function(result) {
							alert(result.msg);
							if (result.success) {
								$('#chapter_tree').treegrid('remove', gid);
							}
						}
					});
				}
			})
		}
		//修改教材
		function editTextbook(node) {
			var url = "/manage/textbook/toTextbookEdit.html?gid=" + node.gid;
			easyui_openNoResizeWindow("修改教材", 500, 270, url, function(r) {
				if (r == undefined || r == "")
					return false;
				if (r) {
					node.text = r.text;
					node.description = r.description;
					$('#chapter_tree').treegrid('update', {
						id : node.gid,
						row : node
					})
				}

			})
		}
		//添加教材
		function addTextbook(tbCode, gid) {
			var url = '/manage/textbook/textbookAdd.html';
			if (tbCode != "" && tbCode != undefined)
				url = '/manage/textbook/textbookAdd.html?tbCode=' + tbCode;
			easyui_openNoResizeWindow("新增教材", 960, 500, url, function(r) {
				$('#chapter_tree').treegrid('reload');
				if (r == undefined || r == "")
					return false;
				if (r && gid) {
					$('#chapter_tree').treegrid('insert', {
						after : gid,
						data : r
					});
				} else {
					var list = new Array();
					list.push(r);
					$('#chapter_tree').treegrid('append', {
						data : list
					});
				}
			})
		}
		//删除教材
		function delTextbook(gid) {
			$.messager.confirm("信息", "确认要删除吗?", function(r) {
				if (r) {
					$.ajax({
						url : "/manage/textbook/deleteTextbook.html",
						data : {
							gid : gid,
						},
						dataType : "json",
						success : function(result) {
							alert(result.msg);
							if (result.success) {
								$('#chapter_tree').treegrid('remove', gid);
							}
						}
					});
				}
			})
		}
		//修改章节
		function editChapter(node) {
			var url = "/manage/textbook/chapter/toChapterEdit.html?gid="
					+ node.gid;
			easyui_openNoResizeWindow("修改教材章节", 500, 270, url, function(r) {
				if (r == undefined || r == "")
					return false;
				if (r) {
					node.text = r.text;
					node.description = r.description;
					$('#chapter_tree').treegrid('update', {
						id : node.gid,
						row : node

					})
				}
			})
		}
		//添加章节
		function addChapter(level, pcode, tbCode, type, gid) {
			var url = "/manage/textbook/chapter/toChapterAdd.html?level="
					+ level + "&pcode=" + pcode + "&tbCode=" + tbCode;
			easyui_openNoResizeWindow("新增教材章节", 500, 280, url, function(r) {
				if (r == undefined || r == "")
					return false;
				if (r) {
					if (type == "addSibling") {
						$('#chapter_tree').treegrid('insert', {
							after : gid,
							data : r
						});
					} else {
						var dataList = new Array();
						dataList.push(r);
						$('#chapter_tree').treegrid('append', {
							parent : gid,
							data : dataList
						});
					}
				}
			})
		}
		//排序格式化
		function sortfmt(value,row) {
			if(row.nodeType!="textbook"){
				return value+"<span id='moveArea'>"
						+"<span class='shang' border='0' onclick='move(this,\""+row.tbCode+"\",\""+row.gid+"\",1)'></span>"
						+"<span class='xia' border='0' onclick='move(this,\""+row.tbCode+"\",\""+row.gid+"\",2)'></span>"
						+"</span>"	
			}else{
				return value;
			}
		}
		/*
		*@param moveType 1向上 2向下	
		*/
		function move(obj,tbCode,gid,moveType){
				$.ajax({
					url:'/manage/textbook/updateTextBookDispOrder.html',
					data:{
						gid:gid,
						type:moveType,
						textbookCode:tbCode,
					},
					async:false,
					success:function(res){
						if(res.success){
							var parent=$('#chapter_tree').treegrid('getParent',gid);	
							/* if(parent){
								$('#chapter_tree').treegrid('reload',parent.gid);
							}else{
								$('#chapter_tree').treegrid('reload');	
							} */
							if(parent){
								var siblings=$('#chapter_tree').treegrid('getChildren',parent.gid);
								siblings=_.filter(siblings,function(item){return item._parentId==parent.gid});
								var orgGid=_.pluck(siblings,'gid');
								var array=new Array();
								if(moveType==1){
									for(var i=0;i<siblings.length;i++){
										if(siblings[i].gid==gid){
											if(i==0){
												return false;
											}
											var temp=siblings[i-1];
											siblings[i-1]=siblings[i];
											siblings[i]=temp;
											break;
										}
									}
								}else{
									for(var i=0;i<siblings.length;i++){
										if(siblings[i].gid==gid){
											if(i==siblings.length-1){
												return false;
											}
											var temp=siblings[i+1];
											siblings[i+1]=siblings[i];
											siblings[i]=temp;
											break;
										}
									}	
								}
								for(var i=0;i<siblings.length;i++){
									array.push(siblings[i])
								}
								for(var i=0;i<orgGid.length;i++){
									$('#chapter_tree').treegrid('remove',orgGid[i]);
									$('#chapter_tree').treegrid('append',{
										parent:parent.gid,
										data:[array[i]],
									});
								}
							}
							
						}else{
							alert(res.msg);
						}
					}
				})
			}
		
	</script>
</body>
</html>