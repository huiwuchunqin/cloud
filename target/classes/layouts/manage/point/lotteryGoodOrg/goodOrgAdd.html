<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<#include "/manage/common/meta_js.html"/> <#include
"/manage/common/meta_css.html"/>
<title>Insert title here</title>
<style type="text/css">
	.attrDiv{
		width:400px;
		margin-left:10px;
		line-height:40px;
	}
	.attrDiv>span:first-of-type{
		width: 90px;
		display: inline-block;
	}
	.attrDiv .numberbox{
		box-sizing: border-box;
		width: 160px !important;
	}
	.square{
		width: 60px;
		height: 27px;
		text-align: center;
	}
	.plus{
		position: absolute;
		left: 240px;
		top: 10px;
		border: 1px solid #ddd;
		height: 11px;
		width: 12px;
		line-height: 9px;
		text-align: center;
		color: grey;
		cursor: pointer;
	}
	.minus{
		position: absolute;
		left: 240px;
		top: 22px;
		border: 1px solid #ddd;
		height: 10px;
		width: 12px;
		text-align: center;
		color: grey;
		line-height: 9px;
		cursor: pointer;
	}
	img{
		margin-left: 4px;
		height:100px;
		width:100px;
		position:absolute;
		z-index: 100;
		cursor: pointer;
	}
	.tip{
		position: absolute;
		left: 127px;
		top: 17px;
		width: 31px;
		height: 0px;
		line-height: 21px;
		color: grey;
	}
	#flagUsing{
		width: 12px !important;
	}
</style>
</head>
<body class="easyui-layout">
<div data-options="region:'north',fit:true,border:false" >
	<form id="addfm">
			<div class="attrDiv">
			<span>面向的角色</span> <input class="easyui-combobox" id="userRoleRequirement"
				name="probability"
				data-options="
			   data:[
				   {name:'教师',code:'10',selected:true},
				   {name:'学生',code:'20'},
			   ],
			   onChange:roleChange,
			   textField:'name',
			   valueField:'code',
			   editable:false,
 				 " />
			</div>
			<div class="attrDiv">
				<span>概率</span> <input class="square easyui-numberbox"  data-options="required:true,suffix:'%',min:0,max:100,precision:2"id="probability" name="probability" />
				<span style="margin-left:20px;">剩余概率<span data-bind="text:left">100</span>%</span>
			</div>
			<div class="attrDiv">
			<span>用于抽奖</span> <input type="radio"  checked="checked" name="flagUsing" id="flagUsing" value="1">是 <input  name="flagUsing" type="radio"  id="flagUsing" value="0">否
			</div>
			<!-- <div class="attrDiv">
			<span>显示顺序</span> <input class="easyui-numberbox" name="dispOrder" id="dispOrder" data-options="required:true,min:0" >
			</div> -->
			<div class="attrDiv">
				<span>商品标识</span> <input class="easyui-combobox"  id="lotteryGoodsType" data-options="
				  data:[
					   {name:'实物',code:'0',selected:true},
					   {name:'虚拟商品，谢谢参与',code:'10'},
					   {name:'虚拟商品，抽一次',code:'20'},
					   {name:'虚拟商品，赠送积分',code:'30'},
				   ],
				   required:true,
				   textField:'name',
				   valueField:'code',
				   editable:false,
				   onChange:goodTypeChange,
				" />
			</div>
			<div  data-bind="visible:type()==0" class="attrDiv">
				<span>商品名称</span> <input id="goodsName" name="goodsName"  class="easyui-validatebox width130" data-options="required:true" maxlength="30" />
			</div>
			<div  data-bind="visible:type()==0"  class="attrDiv">
				<span>商品单位</span> <input id="goodsUnit"  class="width130" name="goodsUnit" maxlength="20" />
			</div>
			<div  data-bind="visible:type()==0 "  class="attrDiv" style="width:350px">
				<span style="float:left">商品规格描述</span> <textarea id="goodsSpecification" name="goodsSpecification"  cols="30" rows="4" maxlength="300"   ></textarea>
			</div>
			<div data-bind="visible:type()==30"class="attrDiv" style="position:relative">
				<span>积分</span> <input type="text"  class="easyui-numberbox square"  data-options="min:0,max:10000" id="pointFeedback" name="pointFeedback" />
				<label class="plus" onclick="jifen(1)">+</label>
				<label class="minus" onclick="jifen(-1)">-</label>
			</div>
		</form>
		<input id="id" name="id" hidden="hidden"/>
		<input id="goodsThumbnailJson" name="goodsThumbnailJson" hidden="hidden"/>
		<!--ko if:type()==0  -->
		<form id="image" enctype="multipart/form-data" method="post" action="/manage/company/uploadImage.html">
		<div class="attrDiv" style="position:relative">
			<span></span> <img id="img" name="img"  />
			<input  id="file"  accept="image/*" name="file"  type="file" hidden="hidden" >
			<label   class="tip" >上传图片</label>
			<input 	hidden="hidden" id="fileType" name="fileType" value="gift">
			
		</div>
		</form>
		<!--/ko -->
</div>
<div data-options="region:'south',border:false" style="text-align:right;">
	<a class="btn btnConfirm" onclick="saveGood()">保存</a>
	<a class="btn btnCancel" onclick="easyui_closeTopWindow()">取消</a>
</div>	
	
<script type="text/javascript">
var goods=eval(${goodsOrg});
var model={
		type:ko.observable("0"),
		left:ko.observable("100"),
}
ko.applyBindings(model);
//显示图片
var imgChanged=false;
var imagePath="";
$(function(){
	imageUpload($("#file"),$("#img"),function(path){imagePath=path;imgChanged=true})
	if(goods){
		$('#lotteryGoodsType').combobox('setValue',goods.lotteryGoodsType);
		$('#goodsName').val(goods.goodsName);
		$('#userRoleRequirement').combobox('setValue',goods.userRoleRequirement);
		$('#goodsSpecification').val(goods.goodsSpecification);
		$('#goodsUnit').val(goods.goodsUnit);
		$('#pointFeedback').numberbox('setValue',goods.pointFeedback);
		$("input[name='flagUsing'][value='"+goods.flagUsing+"']").attr("checked","checked");
		if(goods.goodsThumbnailJson){
			$('#img').attr("src","${imgHost}/"+goods.goodsThumbnailJson);
		}
	/* 	$('#dispOrder').numberbox('setValue',goods.dispOrder); */
		$('#goodsThumbnailJson').val(goods.goodsThumbnailJson);
		$('#id').val(goods.id);
		$('#lotteryGoodsType').combobox('disable');
		$('#probability').numberbox('setValue',goods.probability*100);
	}
	
})
//角色改变事件
function roleChange(record){
$.ajax({
	url:'/manage/lotteryGoodsOrg/getLeftPro.html',
	data:{
		role:record,
	},
	success:function(res){
		if(goods){
			$('#probability').numberbox('clear');	
			if(goods.userRoleRequirement==$('#userRoleRequirement').combobox('getValue')&&goods.flagUsing==1){
				$('#probability').numberbox({max:Number(((res+goods.probability)*100).toFixed(2))});	
				model.left(((res+goods.probability)*100).toFixed(2));
				$('#probability').numberbox('setValue',goods.probability*100);
			}else{
				$('#probability').numberbox({max:Number(((res)*100).toFixed(2))});		
				model.left((res*100).toFixed(2));
				$('#probability').numberbox('setValue',goods.probability*100);
			}
		}else{
			$('#probability').numberbox('clear').numberbox({max:Number((res*100).toFixed(2))});	
			model.left((res*100).toFixed(2));
		}
	}
})	
}

function jifen(value){
	var original=$('#pointFeedback').numberbox('getValue');
	var newValue=isNaN(original)?value:(Number(original)+Number(value));
	newValue<0?$('#pointFeedback').numberbox('setValue',0):$('#pointFeedback').numberbox('setValue',newValue);
}

//商品类型改变事件
function goodTypeChange(newValue){
	model.type(newValue);
	if(newValue!="0"){
		$('#goodsName').val($('#lotteryGoodsType').combobox('getText'));
	}else{
		$('#goodsName').val("");
	}
}
/* //机率改变事件 
function proChange(newValue){
	model.left(100-Number(newValue));
} */

function showPic(){
	var url=window.URL.createObjectURL($('#file')[0].files[0])
	$("#img").attr("src",url);
	imgChanged=true;
}
var isSaving=false;
function saveGood(){
	if($('#addfm').form('validate')&&!isSaving){
		isSaving=true
		var filePath="";
		var opt={
				url:'/manage/lotteryGoodsOrg/addOrgLotteryGood.html',	
				data:{
					goodsName:$('#goodsName').val()||"",
					userRoleRequirement:$('#userRoleRequirement').combobox('getValue'),
					probability:(($('#probability').numberbox('getValue')||0)/100).toFixed(4),
					goodsSpecification:$('#goodsSpecification').val(),
					goodsUnit:$('#goodsUnit').val()||"",
					pointFeedback: $('#pointFeedback').numberbox('getValue')||0,
					dispOrder:0,
					lotteryGoodsType:$('#lotteryGoodsType').combobox('getValue'),
					flagUsing:$("input[name='flagUsing']:checked").val(),
					id:$('#id').val(),
				},
				success:function(res){
					isSaving=false;
					$.messager.alert("信息",res.msg,"info",function(){
						if(res.success){
							easyui_closeTopWindow(true);
						}	
					});
					
					}
				}
		if(opt.data.lotteryGoodsType!="0"){
			opt.data.goodsName=$('#lotteryGoodsType').combobox('getText');
			opt.data.goodsUnit="";
		}else{
			opt.data.pointFeedback=0;
		}
		if(imgChanged){
			/* $('#image').form('submit',{
				success:function(json){
					var res=$.parseJSON(json);
					filePath=res.data;
					opt.data.goodsThumbnailJson=filePath;
					$.ajax(opt)
				}
			}) */
			opt.data.goodsThumbnailJson=imagePath;
			$.ajax(opt)
			
		}else{
			opt.data.goodsThumbnailJson=$('#goodsThumbnailJson').val();
			$.ajax(opt)
		}
	}
}
</script>
</body>
</html>