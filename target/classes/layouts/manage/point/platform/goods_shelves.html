<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>上架礼品页面</title>
<#include "/manage/common/meta_js.html"/>
<#include "/manage/common/meta_css.html"/>
</head>
<body>
<div class="easyui-layout" data-options="fit:true">
		<div data-options="region:'north',split:false,border:false">
		<div class="box form">
		<div class="labelBox">
			    <div class="labelLine240">
				<div class="labelWidth60">角色：</div>
						<input id="userRoleRequirement"
					     class="easyui-combobox"
					     data-options="editable:false,textField:'label',valueField:'value',
					     data: [{
								label: '不限',
								value: '0',
								selected:true
							},{
								label: '教师',
								value: '10'
							},{
								label: '学生',
								value: '20'
							}],panelHeight:'auto'"/>
				</div>
		</div>
			<div class="btnBox">
			    <a id="btnSearch" class="btn btnBlue search" onclick="query()">查询</a>
				<a id="btnAdd" class="btn btnBlue" data-options="iconCls:'icon-add'" onclick="addGoods()">新增礼品</a>
			</div>
	   </div>
      </div>
    <div data-options="region:'center',border:false">
	<table id="shelves_dg" class="easyui-datagrid"
		data-options="
	    pagination:true,
	    fit:true,
	    rownumbers:true,
	    onBeforeLoad:dgOnBeforeLoad, 
	    singleSelect:true,
	    url : '/manage/point/platform/goods/shelves/search.html'
	    ">
		<thead>
			<tr>
			    <th data-options="field:'operate',width:150,align:'center',formatter:operatefmt,halign:'center'">操作</th>
                <th data-options="field:'goodsThumbnailJson',halign:'center',align:'center',width:120,formatter:fmtGoodsPic">礼品图片</th>
				<th data-options="field:'goodsName',halign:'center',align:'left',width:150">礼品名称</th>
				<th data-options="field:'points',halign:'center',align:'right',width:80">所需积分</th>
				<th data-options="field:'dispOrder',halign:'center',align:'right',width:80">显示顺序</th>
				<th data-options="field:'userRoleRequirement',halign:'center',align:'center',width:80,formatter:rolefmt">面向人群</th>
				<th data-options="field:'validTimeStart',width:140,halign:'center',align:'center',formatter:timefmt">上架时间</th>
				<th data-options="field:'id',width:50,hidden:true,halign:'center'">id</th>
			</tr>
		</thead>
	</table>
	</div>
	</div>
	<script type="text/javascript">
		//查询条件
		function dgOnBeforeLoad(param) {
			param["userRoleRequirement"] = $('#userRoleRequirement').combobox('getValue');
		}

		//查询上架礼品信息
		function query() {
			$('#shelves_dg').datagrid('reload');
		}

		//操作列格式化
		function operatefmt(value, row) {
			var str = "<a href='javascript:void(0)' onclick='edit(this)'>编辑</a>"; 
			str+="&nbsp;&nbsp;<a href='javascript:void(0)' onclick='giftDown(this)'>下架</a>";
			str+="&nbsp;&nbsp;<a href='javascript:void(0)' onclick='del(this)'>删除</a>";
			/* str+="&nbsp;&nbsp;<a href='javascript:void(0)' onclick='put(this)'>入库</a>";
			str+="&nbsp;&nbsp;<a href='javascript:void(0)' onclick='putList(this)'>入库明细</a>"; */
			return str;
		}

		//上架时间格式化 
		function timefmt(value, row) {
			var result="";
			if(value!=null&&value!=""){
				result=moment(value,"YYYYMMDDHHmmss").format("YYYY-MM-DD HH:mm");
			}
			return result;
		}
		
		//面向人群格式化
		function rolefmt(value,row){
			var result="";
			if(value=="0"){
				result="全部";
			}else if(value=="10"){
				result="教师";
			}else if(value=="20"){
				result="学生";
			}else{
				result="";
			}
			return result;
		}
		
		//格式化图片显示
		function fmtGoodsPic(value,row) {
			var result="";
			if(value==null||value==""){
				result="<img width=50 height=50 src='/manage/resources/images/goods/goods_default.png'/>";
			}else{
				result="<img width=50 height=50 src='${imgHost}/"+value+"'/>"
			}
			return result;
		}
		
		//礼品下架
		function giftDown(obj){
			var index=$(obj).closest("tr").index();
			$('#shelves_dg').datagrid('selectRow',index);
			var row=$('#shelves_dg').datagrid('getSelected');
			var opts={
					url:'/manage/point/platform/goods/upOrDown.html',
					data:{
						id:row.id,
						type:1
					},
					success:function(json){
						var res=json;
						$.messager.alert('信息',res.msg,'info',function(r){
							$('#shelves_dg').datagrid('reload');
						})
					},
					error : function(XMLHttpRequest, textStatus, errorThrown) {
						alert("网络繁忙请稍后再试");
					}
			}
			$.messager.confirm("提示", "确定要下架该礼品？", function (r){
		    	  if(r){
		    	       $.ajax(opts);
		    	  }
		    });
		}
		
		//新增礼品
		function addGoods() {
			easyui_openNoResizeWindow("新增礼品", 600, 400, "/manage/point/platform/goods/add.html",
					function(r) {
				      if(r){
					      $('#shelves_dg').datagrid('reload');
				      }
			});
		}
		
		//修改礼品
		function edit(obj){
			var index = $(obj).closest("tr").index();
			$('#shelves_dg').datagrid('selectRow',index);
			var row=$('#shelves_dg').datagrid('getSelected');
			easyui_openNoResizeWindow("修改礼品",600, 400, "/manage/point/platform/goods/edit.html?id="+row.id, function(r) {
				if(r){
					$('#shelves_dg').datagrid('reload');	
				}
				});
		}
		
		//删除功能
		function del(obj){
			var index=$(obj).closest("tr").index();
			$('#shelves_dg').datagrid('selectRow',index);
			var row=$('#shelves_dg').datagrid('getSelected');
			var opts={
					url:'/manage/point/platform/goods/delete.html',
					data:{
						id:row.id
					},
					success:function(json){
						var res=json;
						$.messager.alert('信息',res.msg,'info',function(r){
							$('#shelves_dg').datagrid('reload');
						})
					},
					error : function(XMLHttpRequest, textStatus, errorThrown) {
						alert("网络繁忙请稍后再试");
					}
			}
			$.messager.confirm("提示", "确定删除该礼品？", function (r){
		    	  if(r){
		    	       $.ajax(opts);
		    	  }
		    });
		}
		
		//入库
		function put(obj){
			var index = $(obj).closest("tr").index();
			$('#shelves_dg').datagrid('selectRow',index);
			var row=$('#shelves_dg').datagrid('getSelected');
			easyui_openTopWindow("礼品入库", 500, 400,
						"/manage/pointGoodsPutPlatform/toGoodsPutAdd.html?id="
								+ row.id, function(r) {
							if (r) {
								$('#shelves_dg').datagrid('reload');
							}
				});
		}
		
		//入库明细
		function putList(obj){
			var index = $(obj).closest("tr").index();
			$('#shelves_dg').datagrid('selectRow',index);
			var row=$('#shelves_dg').datagrid('getSelected');
			easyui_openTopWindow("入库明细", 500, 600,
					"/manage/pointGoodsPutPlatform/toGoodsPut.html?id="
							+ row.id, function(r) {
						if (r) {
							$('#shelves_dg').datagrid('reload');
						}
					});
		}
	</script>
</body>
</html>