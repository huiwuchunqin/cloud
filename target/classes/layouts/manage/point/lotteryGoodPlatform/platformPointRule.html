<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<#include "/manage/common/meta_js.html"/> 
<#include "/manage/common/meta_css.html"/>
<title>机构抽奖规则</title>
</head>
<body>
<div  id="tb">
	<a class="btn btnBlue" iconCls="icon-add" onclick="addRule()">新增抽奖规则</a>
</div>
<table id="dg" class="easyui-datagrid" data-options="
	pagination:true,
	singleSelect:true,
	rownumbers:true,
	toolbar:'#tb',
	fit:true,
	url:'/manage/platfromPointRule/list.html'
">
<thead>
	<tr>
	<th data-options="field:'opt',width:130,formatter:optfmt,align:'center',halign:'center'">操作</th>
	<!-- <th data-options="field:'point',width:80,align:'right',halign:'center'">消费积分</th> -->
	<th data-options="field:'dayMaxTimes',formatter:timesfmt,width:120,align:'center',halign:'center'">每日最多抽奖数</th>
	<th data-options="field:'startTime',formatter:timefmt,width:140,align:'center',halign:'center'">版本开始日期</th>
	<th data-options="field:'expireTime',formatter:timefmt,width:140,align:'center',halign:'center'">版本失效日期</th>
	<th data-options="field:'memo',width:420,halign:'center',align:'left'">备注</th> 
	</tr>
</thead>
</table>
</body>
<script type="text/javascript">
		//新增积分规则 
		function addRule(){
			easyui_openNoResizeWindow("新增积分规则",400,250,"/manage/platfromPointRule/toPlatformRuleAdd.html",function(r){
				if(r){
					$('#dg').datagrid('reload');
				}
			})
		}
		//时间格式化
		function timefmt(value,row){
			if(value){
				return value=="99999999999999"?"":moment(value,"YYYYMMDDHHmmss").format("YYYY-MM-DD H:mm")	
			}else{
				return value;
			}
		}
		//抽奖次数格式化
		function timesfmt(value,row){
			if(value==0){
				return "不限";
			}else{
				return value;
			}
		}
		
		//操作格式化
		function optfmt(value,row){
			var str="";
			str="<a href='javascript:void(0)' onclick='deleteRule("+row.id+")'>删除</a>"
			if(row.expireTime!="99999999999999"){
				var expireTime=moment(row.expireTime,"YYYYMMDDHHmmss").format("YYYY-MM-DD H:mm");
				var currentTime=moment(new Date(),"YYYYMMDDHHmmss").format("YYYY-MM-DD H:mm");
				if(expireTime>currentTime){
					str=str+"&nbsp;<a href='javascript:void(0)' onclick='editRule("+row.id+")'>修改</a>";
				}
			}else{
				str=str+"&nbsp;<a href='javascript:void(0)' onclick='editRule("+row.id+")'>修改</a>";
			}
			return str;
		}
		
		//修改积分规则
		function editRule(id){
			easyui_openNoResizeWindow("修改积分规则",400,250,"/manage/platfromPointRule/toPlatformRuleEdit.html?id="+id,function(r){
				if(r){
					$('#dg').datagrid('reload');
				}
			})
		}
		//删除
		function deleteRule(id){
			$.messager.confirm("信息","确认删除吗？",function(r){
				if(r){
					$.ajax({
						url:'/manage/platfromPointRule/delete.html',
						data:{
							id:id,
						},
						success:function(res){
							$.messager.alert("信息",res.msg,"info",function(){
								if(res.success){
									$('#dg').datagrid('reload');
								}
							})
						}
					})
				}
			})
		}
</script>
</html>