<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<#include "/manage/common/meta_js.html"/> <#include
"/manage/common/meta_css.html"/>
<script type="text/javascript"
	src="/manage/moveToCommon/js/knockout-easyui-Lite/knockout-easyui.debug.js"></script>
<script type="text/javascript"
	src="/manage/moveToCommon/js/kovalidate/knockout.validation.js"></script>
<script type="text/javascript"
	src="/manage/moveToCommon/js/kovalidate/zh-CN.js"></script>
<title>机构学年学期</title>
</head>
<style type="text/css">
.attrDiv {
	height: 36px;
	line-height: 36px;
	padding-left: 29px;
}

.attrDiv>span {
	display: inline-block;
	width: 90px;
}
.attrDiv .textbox{
	height: 30px !important;
}
.attrDiv .textbox .combo-arrow{
	height: 30px !important;
	width: 30px !important;
}
.btnBox{
	position: absolute;
	bottom: 15px;
	right: 0;
}
</style>
<body>
	<div id="tb">
		<a class="btn btnBlue add align-right"  onclick="addfm()">新增</a>
	</div>
	<table id="dg" class="easyui-datagrid"
		data-options="
		toolbar:'#tb',
	    pagination:true,
	    fit:true,
	    rownumbers:true,
	    singleSelect:true,
	    url:'/manage/studyYear/orgYearTermPageList.html'
	    ">
		<thead>
			<tr>
				<th data-options="field:'opt',formatter:termOptfmt,halign:'center',align:'center',width:150">操作</th>
				<th data-options="field:'sectionName',width:100,halign:'center',align:'center'">学段名称</th>
				<!-- <th data-options="field:'orgName',width:150,halign:'center',align:'left'">机构名称</th> -->
				<th data-options="field:'yearTermName',width:250,halign:'center',align:'center'">学年学期名称</th>
				<th data-options="field:'startDate',halign:'center',formatter:timefmt,width:250,align:'center'">开始日期</th>
				<th data-options="field:'endDate',width:250,align:'center',formatter:timefmt,halign:'center'">结束日期</th>
				<th data-options="field:'totalWeekNum',width:200,align:'center',halign:'center'">总周数</th>
			</tr>
		</thead>
	</table>
	<div id="dialog" class="easyui-dialog"
		style="width: 400px; height: 280px;"
		data-options="
			closed:true,
			modal:true,
         ">
		<form id="fm" class="box">
			<div class="attrDiv">
				<span>学年学期</span> <input id="term" class="easyui-combobox "
					data-bind="comboboxSource:term.source,comboboxValue:term.val,easyuiOptions:term.viewSettings" />
			</div>
			
			<div class="attrDiv t10">
				<span>开始日期</span> <input class="easyui-validatebox"
					data-options="required:true" id="startDate" class="Wdate"
					onfocus="WdatePicker({maxDate:'#F{$dp.$D(\'endDate\')}',dateFmt:'yyyy-MM-dd '})"
					data-options="validType:'yyyy'" />
			</div>

			<div class="attrDiv t10">
				<span>结束日期</span> <input class="easyui-validatebox"
					data-options="required:true" id="endDate" class="Wdate"
					onfocus="WdatePicker({minDate:'#F{$dp.$D(\'startDate\')}',dateFmt:'yyyy-MM-dd '})"
					data-options="validType:'yyyy'" />
			</div>
			<div  class="btnBox">
				<a class="btn btnConfirm" onclick="updateYearTerm()">保存</a>
				<a class="btn btnCancel" onclick="closeYearTerm()">取消</a>
			</div>
			
		</form>

	</div>
	<div id="addDialog" class="easyui-dialog box"
		style="width: 400px; height: 150px;"
		data-options="
			closed:true,
          ">
		<div class="attrDiv t10">
			<span>平台学期</span> <input id="term" style="width: 180px"
				class="easyui-combobox"
				data-bind="comboboxSource:platTerm.source,comboboxValue:platTerm.val,easyuiOptions:platTerm.viewSettings" />
		</div>
		<div  class="align-right t20">
		<a class="btn btnConfirm" onclick="saveYearTermAdd()">保存</a>
		<a class="btn btnCancel" onclick="closeYearTermAdd()">取消</a>
		</div>

	</div>
	<script type="text/javascript">
var termList=eval(${termList});
var platTermList=eval(${platTermList});
var page=new PageModel();
page.term.source(termList);
page.platTerm.source(platTermList);
ko.applyBindings(page)
function PageModel(){
	var self=this;

	self.yearTermGid=ko.observable("")
	self.term={
		source:ko.observableArray([]),
		val:ko.observable(""),
		viewSettings:{
			required:true,
			editable:false,
			textField:'yearTermName',
			valueField:'yearTermCode',
		}
	}
	self.platTerm={
		source:ko.observableArray([]),
		val:ko.observable(""),
		viewSettings:{
			required:true,
			editable:false,
			textField:'yearTermName',
			valueField:'gid',
		}	
	}

return self;
	
}
//保存学年学期
function updateYearTerm(){
	if($('#fm').form('validate')){
		$.ajax({
			url:'/manage/studyYear/updateOrgYearTerm.html',
			data:{
				yearTermCode:page.term.val(),
				startDateStr:$('#startDate').val(),
				endDateStr:$('#endDate').val(),
				gid:page.yearTermGid()
			},
			type:'post',
			success:function(res){
				$.messager.alert("信息",res.msg);
				closeYearTerm();
				$('#dg').datagrid('reload');
			}
		})
	}
}
/**
 * 删除学期
 */
function deleteTerm(_gid){
	$.messager.confirm("确认","确认删除吗？",function(r){
		if(r){
			$.ajax({
				url:'/manage/studyYear/deleteOrgYearTerm.html',
				data:{gid:_gid},
				type:'post',
				success:function(res){
					$.messager.alert("信息",res.msg);
					$('#dg').datagrid('reload');
				}
			})
		}
	})
}
//关闭学期编辑窗口
function closeYearTerm(){
	$('#dialog').dialog('close');	
}

//关闭学期新增窗口
function closeYearTermAdd(){
	$('#addDialog').dialog('close');
}
//保存学期
function saveYearTermAdd(){
	if(_.isEmpty(page.platTerm.val())){
		$.messager.alert("信息","请选择学期");
		return false;
	}
	$.ajax({
		url:'/manage/studyYear/selectIntoOrgTerm.html',
		data:{
			gid:page.platTerm.val(),
		},
		type:'post',
		success:function(res){
			$.messager.alert("信息",res.msg)
			if(res.success){
				closeYearTermAdd();
				$('#dg').datagrid('reload');
			}
		}
		
	})
}

//新增学期
function addfm(){
	clear();
	$('#addDialog').dialog({title:"新增学年学期"}).dialog('open');		
}
//清空
function clear(){
	page.term.val("");
	page.platTerm.val("");
	page.yearTermGid("");
	$('#startDate').val("");
	$('#endDate').val(""); 
}
//修改
function modifyTerm(obj){
	clear();
	$('#dialog').dialog({title:"修改学年学期"}).dialog('open');	
	var index=$(obj).closest("tr").index();
	$('#dg').datagrid('selectRow',index);
	var row=$('#dg').datagrid('getSelected');
 	$('#term').combobox('disable');
	page.term.val(row.yearTermCode);
	page.yearTermGid(row.gid);
	$('#startDate').val(moment(row.startDate).format("YYYY-MM-DD"));
	$('#endDate').val(moment(row.endDate).format("YYYY-MM-DD")); 
	
}
function timefmt(value,row){
	if(value){
		return moment(value).format("YYYY-MM-DD");	
	}else{
		return "";
	}
}

//机构学年学期操作列格式化
function termOptfmt(value,row){
	var operateStr="";
	var nowDate=moment(new Date()).format("YYYY-MM-DD");
	var startDate=moment(row.startDate).format("YYYY-MM-DD");
	if(startDate>nowDate){
		operateStr="<a href='javascript:void(0)' onclick='modifyTerm(this)'>修改</a> &nbsp;<a href='javascript:void(0)' onclick='deleteTerm(\""+row.gid+"\")'>删除</a>";
	}
	return operateStr;
}
</script>
</body>
</html>