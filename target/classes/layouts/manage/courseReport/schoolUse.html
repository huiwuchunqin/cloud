<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>课程统计-学校使用情况统计</title> <#include "/manage/common/meta_js.html"/>
<#include "/manage/common/meta_css.html"/>
<script type="text/javascript"
	src="/manage/template/comboChange/comboChange.js"></script>
</head>
<body>
	<div class="easyui-layout" data-options="fit:true">
		<div data-options="region:'north'">
			<div class="box">
				<div class="labelBox">
					<div class="labelLine440">
						<span class="labelWidth60">日期：</span> <input id="startDate"
							class="Wdate"
							onfocus="WdatePicker({maxDate:'#F{$dp.$D(\'endDate\')}',dateFmt:'yyyy-MM-dd'})" />
						~ <input id="endDate" class="Wdate"
							onfocus="WdatePicker({minDate:'#F{$dp.$D(\'startDate\')}',dateFmt:'yyyy-MM-dd'})" />
					</div>
					<span class="clear10"></span>
					<div class="labelLine240">
						<span class="labelWidth60">学段：</span><input id="section" 
							class="easyui-combobox" 
							data-options="
							valueField: 'code',
							textField: 'name',
							panelHeight: 'auto',
							editable: false,
							data: [
								{code: '',name: '全部',selected:true}
								<#if (sectionList?exists && sectionList?size>0)>
							  		<#list sectionList as section>
							  			,{code:'${section.code}', name:'${section.name?default('&nbsp;')}'}
							  		</#list>
								</#if>
							]" />
					</div>
					<span class="clear10"></span>
					<div class="labelLine240">
						<span class="labelWidth60">学校：</span><input
							class="easyui-validatebox width130" id="orgName" name="orgName"
							maxlength="60" placeholder="请输入学校名称" />
					</div>
				</div>
				<div class="btnBox">
					<button class="btn btnBlue search" style="margin-top: 20px"
						onclick="query()">查询</button>
				</div>
			</div>
		</div>
		<div data-options="region:'center'">
			<div id="tb" class="tbClass">
				<span class="attr" style="margin-left: 10px">学校数：<label
					id="schoolTotal"></label></span>
				<!-- <span class="attr"
					style="margin-left: 15px">被引用数：<label id="referCountTotal"></label></span> -->
				<span class="attr" style="margin-left: 15px">引用数：<label
					id="referedCountTotal"></label></span>
				<button class="btn btnBlue" style="float: right"
					onclick="exportData()">导出</button>
				<span style="clear: both; display: none"></span>
			</div>
			<table id="dg" class="easyui-datagrid"
				data-options="
					 pagination:true,
					 onBeforeLoad:onBeforeLoad,
					 rownumbers:true,
					 singleSelect:true,
					 toolbar:'#tb',
					 fit:true,
					 url:'/manage/course/schoolUse/search.html'
		        ">
				<thead>
					<tr>
						<th
							data-options="field:'orgName',width:300,halign:'center',align:'left'">学校</th>
						<th
							data-options="field:'sectionName',width:90,align:'center',halign:'center'">学段</th>
						<!-- <th
							data-options="field:'referCount',width:80,align:'center',halign:'center'">被引用数</th> -->
						<th data-options="field:'orgCode',hidden:true"></th>
						<th
							data-options="field:'referedCount',width:80,align:'center',halign:'center'">引用数</th>
						<th data-options="field:'orgCode',hidden:true"></th>
						<th data-options="field:'sectionCode',hidden:true"></th>
					</tr>
				</thead>
			</table>
		</div>
	</div>
	<script type="text/javascript">
		//查询
		function query() {
			$('#dg').datagrid('reload');
			queryTotal();
		}

		//查询总数
		function queryTotal() {
			var sectionCode = $("#section").combobox('getValue');
			var orgName = $("#orgName").val();
			var start = $("#startDate").val();
			var end = $("#endDate").val();
			if (end == "" || end == null) {
				end = moment(new Date()).format("YYYY-MM-DD");
			}
			var opts = {
				url : '/manage/course/schoolUse/searchTotal.html',
				type : "post",
				data : {
					sectionCode : sectionCode,
					orgName : orgName,
					startDate : start,
					endDate : end
				},
				success : function(data) {
					$('#schoolTotal').text(data.orgTotal || 0);
					$('#referCountTotal').text(data.referTotal || 0);
					$('#referedCountTotal').text(data.referedTotal || 0);
				},
				error : function(XMLHttpRequest, textStatus, errorThrown) {
					alert("网络繁忙请稍后再试");
				},
				complete : function() {

				}
			}
			$.ajax(opts);
		}

		$(function() {
			queryTotal();
		})

		function onBeforeLoad(param) {
			param["sectionCode"] = $("#section").combobox('getValue');
			param["orgName"] = $("#orgName").val();
			var startDate = $("#startDate").val();
			var endDate = $("#endDate").val();
			if (endDate == "" || endDate == null) {
				endDate = moment(new Date()).format("YYYY-MM-DD");
			}
			param["startDate"] = startDate;
			param["endDate"] = endDate;
		}

		//导出数据
		function exportData() {
			var sectionCode = $("#section").combobox('getValue');
			var orgName = $("#orgName").val();
			var startDate = $("#startDate").val();
			var endDate = $("#endDate").val();
			if (endDate == "" || endDate == null) {
				endDate = moment(new Date()).format("YYYY-MM-DD");
			}
			downloadHelper("/manage/course/schoolUse/export.html?sectionCode="
					+ sectionCode + "&orgName=" + encodeURI(orgName)
					+ "&baseDateStart=" + startDate + "&baseDateEnd=" + endDate
					+ "&fileName=" + getExportName());
		}
	</script>
</body>
</html>