<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>教学班级</title> 
<#include "/manage/common/meta_js.html"/> 
<#include "/manage/common/meta_css.html"/>
<script type="text/javascript" src="/manage/template/comboChange/orgComboChange.js"></script>
<style type="text/css">
</style>
</head>
<body>
<div id="layout"class="easyui-layout" data-options="fit:true">
<div data-options="region:'center'">
<div id="tb">
	<div class="box">
		<div class="labelBox">
			<div class="labelLine240">
				<span class="labelWidth60">学段：</span> <input
					class="easyui-combobox width130" id="section"
					data-options="
			valueField: 'code',
			textField: 'name',
			panelHeight: 'auto',
			editable: false,
			onSelect:sectionSelect
		"/>
			</div>
			<div class="labelLine240">
				<span class="labelWidth60">学科：</span> <input
					class="easyui-combobox width130" id="subject"
					data-options="
			valueField: 'code',
			textField: 'name',
			panelHeight: 'auto',
			editable: false,
			data:[{name:'不限',code:'',selected:true}]"/>
			</div>
			<div class="labelLine240">
				<span class="labelWidth60">年级：</span> <input
					class="easyui-combobox width130" id="grade"
					data-options="
			valueField: 'code',
			textField: 'name',
			panelHeight: 'auto',
			editable: false,
			data:[{name:'不限',code:'',selected:true}]"/>
			</div>
			<span class="clear10"></span>
			<div class="labelLine240">
				<span class="labelWidth60">班级名称：</span>
				<input id="classNameFliter" placeholder="请输入班级名称"/>
			</div>
			<div class="labelLine240">
				<span class="labelWidth60">老师名称：</span>
				<input id="teacherName" placeholder="请输入老师名称"/>
			</div>
		</div>
		<div class="btnBox">
			<a class="btn btnBlue search" onclick="searchDg()">查询</a>
			<!-- <a class="btn btnBlue add""  onclick="addClass()" data-options="iconCls:'icon-add'">新增</a> -->
			<!-- <a class="btn btnBlue"  onclick="importDefault()">导入默认</a> -->
		</div>
	</div>

</div>
	<table id="dg" class="easyui-datagrid"
		data-options="
			pagination:true,
			rownumbers:true,
			onBeforeLoad:onBeforeLoad,
			toolbar:'#tb',
			singleSelect:true, 
			fit:true,
			pageSize:15,
			url:'/manage/teachingClass/list.html'
        ">
	<thead>
		<tr>
			<!-- <th data-options="field:'opt',formatter:opt,width:90">操作</th> -->
			<th data-options="field:'teacherName',width:120,halign:'center',align:'left'">老师</th>
			<th data-options="field:'teachingClassName',width:120,halign:'center',align:'left'">班级名称</th>
			<th data-options="field:'studyYearCode',width:80,halign:'center',align:'center'">学年</th>
			<th data-options="field:'subjectName',width:100,halign:'center',align:'center'">学科</th>
			<th data-options="field:'gradeName',width:100,halign:'center',align:'center'">年级</th> 
			<!-- <th data-options="field:'startTime',formatter:timeFmt,width:90,halign:'center',align:'center'">开始时间</th>
			<th data-options="field:'endTime',formatter:timeFmt,width:90,halign:'center',align:'center'">结束时间</th> -->
			<th data-options="field:'studentCount',align:'center',formatter:stufmt,width:80,halign:'center'">学生数</th>
		</tr>
	</thead>
	</table>
	<div id="dlg" class="easyui-dialog" data-options="
			width:700,
			height:500,
			closed:true,
			buttons:[
			{
			text:'保存',
			iconCls:'icon-save',
			handler:saveClass,
			},
			{
			text:'取消',
			iconCls:'icon-cancel',
			handler:function(){
			$('#dlg').dialog('close');
			},
			}],
			modal:true,
	">
		<form id="fm" style="padding:10px">
			<div class="attrDiv">
			<span>班级名称</span>
			<input id="teachingClassName" class="easyui-validatebox" maxlength="10"
			 data-options="required:true,validType:'length[0,10]'"/>
			</div>
			<div class="attrDiv">
				<span>老师</span> <input id="teacher" class="easyui-combobox"
					data-options="
					textField:'userName',
					valueField:'teacherCode',
					required:true,
					">
			</div>
			<ul data-bind="visible:add()">
			<div class="attrDiv">
				<span>学段</span> <input id="addSection" class="easyui-combobox"
					data-options="
					onChange:addSectionChange,
					textField:'name',
					valueField:'code',
					editable:false,
					required:true,
					">
			</div>
		
			<div class="attrDiv">
				<span>学科</span> <input id="addSubject" class="easyui-combobox"
					data-options="
					textField:'name',
					valueField:'code',
					editable:false,
					required:true,
					">
			</div>
			<div class="attrDiv">
				<span>年级</span> <input id="addGrade" class="easyui-combobox"
					data-options="
					onChange:gradeChange,
					textField:'name',
					valueField:'code',
					editable:false,
					required:true,
					">
			</div>
			<div class="attrDiv">
				<span>学年学期</span> <input id="yearTerm" class="easyui-combobox"
					data-options="
					textField:'yearTermName',
					valueField:'yearTermCode',
					editable:false,
					required:true,
					">
			</div>
			<div class="attrDiv">
				<span>行政班级</span> <input id="adminClassCode" class="easyui-combobox"
					data-options="
					textField:'className',
					valueField:'classCode',
					editable:false,
					">
			</div>
			</ul>
			<div class="attrDiv">
			<span>开始时间</span><input id="startTime" class="Wdate" onfocus="WdatePicker({dataFmt:'yyyy-MM-dd',maxDate:'#F{$dp.$D(\'endTime\')}'})">
			</div>
			<div class="attrDiv">
			<span>结束时间</span><input id="endTime" class="Wdate" onfocus="WdatePicker({dataFmt:'yyyy-MM-dd',minDate:'#F{$dp.$D(\'startTime\')}'})">
			</div>
			<input id="gid" style="display:none"/>
			<input id="teachingClassSubjectGid" style="display:none"/>
		</form>
	</div>
</div>
<!-- 	<div id="detail" style="height: 0px;"
			data-options="region:'south',split:true">
			<iframe id="frm" frameborder="0" scrolling="no" height="0px"
				width="100%"></iframe>
		</div> -->
</div>
	<script type="text/javascript">
		var teacherList=eval(${teacherList}),sectionList=eval(${sectionList});
		$(function(){
			$('#teacher').combobox('loadData',teacherList);
			$('#addSection').combobox('loadData',sectionList);
			$('#section').combobox('loadData',sectionList);
			$('#section').combobox('select',sectionList[0].code);
		})
		var model={
			add:ko.observable(true)
		}
		ko.applyBindings(model);
		
		//班主任手动输入过滤
		$('#teacher').combobox({
			onSelect:function(row,index){
				teacherSectionLock(row,$('#teacher'),$('#addSection'))
			}
		})
		
		function onBeforeLoad(param) {
		param["teachingClassName"]=$('#classNameFliter').val()?$('#classNameFliter').val().trim():"";
		param["subjectCode"]=$('#subject').combobox('getValue');
		param["sectionCode"]=$('#section').combobox('getValue');
		param["gradeCode"]=$('#grade').combobox('getValue');
		param["teacherName"]=$('#teacherName').val();
		}
		
		//班级学生格式化化
		function stufmt(value,row){
			return "<a href='javascript:void(0)' onclick='viewStudent(\""+row.adminClassCode+"\",\""+row.teachingClassCode+"\",\""+row.gradeCode+"\")'>"+value+"</a>"
		}
		function opt(value,row){
			return "<a href='javascript:void(0)' onclick=editClass(this)>修改</a>";
		}
		//教学班级学生
		function  viewStudent(adminClassCode,teachingClassCode,gradeCode){
			$('#layout').layout('remove','south');
			$('#layout').layout('add',{
				region:'south',
				title:'学生信息',
				split:true,
				href:'/manage/teachingClassStudent/toClassStudent.html?adminClassCode='+adminClassCode+'&teachingClassCode='+teachingClassCode+"&gradeCode="+gradeCode,
				height:300,	
			})
		}
		
		//查询
		function searchDg(){
			$('#dg').datagrid('reload');
		}
		//新增
		function addClass(){
		model.add(true);
		$('#fm').form('clear');
		$('#dlg').dialog({title:"新增教学班级",height:500}).dialog('open');
		}
		//学段改变事件
		function addSectionChange(value){
			orgSectionSubject(value,$('#addSubject'));
			orgSectionGrade(value,$('#addGrade'));
			orgSectionYearTerm(value,$('#yearTerm'));
		}
		function sectionSelect(data){
			orgSectionSubject(data.code,$('#subject'),true);
			orgSectionGrade(data.code,$('#grade'),true);
		}
		//年级改变事件
		function gradeChange(value){
			orgGradeAdminClass(value,$('#adminClassCode'));
		}
		//保存课程班级
		function saveClass(){
			if($('#fm').form('validate')||!model.add()){
				if($('#teachingClassName').val()==""){
					$('#teachingClassName').focus();
					return;
				}
				var gid=$('#gid').val();
			
				var teachingClass={
						teachingClassName:$('#teachingClassName').val(),
						startTimeStr:$('#startTime').val(),
						endTimeStr:$('#endTime').val(),
						gid:$('#gid').val(),
						teacherCode:$('#teacher').combobox('getValue'),
						teacherName:$('#teacher').combobox('getText'),
						teachingClassSubjectGid:$('#teachingClassSubjectGid').val(),
				}
				if(!gid){
					var termSelect=$('#yearTerm').combobox('getValue');
					var yearTermList=$('#yearTerm').combobox('getData');
					var selectedTerm=_.find(yearTermList,function(item){
						return item.yearTermCode==termSelect;
					})
					_.extend(teachingClass,{
						gradeCode:$('#addGrade').combobox('getValue'),
						subjectCode:$('#addSubject').combobox('getValue'),
						teacherCode:$('#teacher').combobox('getValue'),
						adminClassCode:$('#adminClassCode').combobox('getValue'),
						studyYearCode:selectedTerm.studyYearCode,
						termCode:selectedTerm.termCode,
					})
				}
				$.ajax({
					url:'/manage/teachingClass/saveOrUpdate.html',
					data:teachingClass,
					success:function(res){
						$.messager.alert("信息",res.msg);
						if(res.success){
							searchDg();
							$('#dlg').dialog('close');
						}
					}
				})
			}
		}
		//时间格式化
		function timeFmt(value,row){
			return value?moment(value).format("YYYY-MM-DD"):"";
		}
		//修改
		function editClass(obj){
			var index=$(obj).closest("tr").index();
			$('#dg').datagrid('selectRow',index);
			var row=$('#dg').datagrid('getSelected');
			model.add(false);
			$('#fm').form('clear');
			$('#dlg').dialog({title:"修改教学班级",height:200}).dialog('open');
			$('#gid').val(row.gid);
			$('#teachingClassSubjectGid').val(row.teachingClassSubjectGid);
			$('#teachingClassName').val(row.teachingClassName);
			if(row.startTime){
				$('#startTime').val(moment(row.startTime).format("YYYY-MM-DD"));	
			}
			if(row.endTime){
				$('#endTime').val(moment(row.endTime).format("YYYY-MM-DD"));
			}
			if(row.teacherCode){
				$('#teacher').combobox('setValue',row.teacherCode);	
			}
		}
		//导入默认
		function importDefault(){
			var opt={
					url:'/manage/teachingClass/importDefault.html',
					success:function(res){
						$.messager.alert("信息",res.msg);
						layer.closeAll();
						if(res.success){
							$('#dg').datagrid('reload');
						}
					}
				}
			$.messager.confirm("信息","你确定要导入默认数据吗？,操作会根据老师对应的行政班级学科生成课程班级",function(r){
				if(r){
					$.ajax(opt);
					layer.load(3,{shade:0.1});
				}
			})
		}
	</script>
</body>
</html>